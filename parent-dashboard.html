<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Parent Dashboard — Revamped</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --primary:#6366f1;
      --primary-2:#4f46e5;
      --bg:#f4f6fb;
      --card:rgba(255,255,255,0.75);
      --muted:#6b7280;
      --success:#22c55e;
      --danger:#ef4444;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body {
      font-family:Inter,Segoe UI,Roboto,system-ui;
      background:linear-gradient(135deg,#eef2ff,#f8fafc);
      min-height:100vh;
      padding:20px;
      color:#111827;
      display:flex;
      justify-content:center;
    }
    .container { width:100%; max-width:1200px }

    /* Header */
    header {
      display:flex; align-items:center; gap:16px; margin-bottom:20px;
    }
    .brand {
      display:flex; align-items:center; gap:12px;
      background:var(--card); backdrop-filter:blur(10px);
      padding:12px 18px; border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,0.06);
    }
    .brand img { height:50px; width:50px; border-radius:12px; object-fit:cover }
    .brand h1 { font-size:1.3rem; color:var(--primary); margin:0 }
    .profile-menu { margin-left:auto; display:flex; align-items:center; gap:14px }
    .profile-btn {
      background:var(--primary); border:0; color:white;
      padding:10px 14px; border-radius:12px; cursor:pointer;
      transition:background 0.3s;
    }
    .profile-btn:hover { background:var(--primary-2) }

    /* Dashboard Layout */
    .dashboard-grid {
      display:grid; grid-template-columns:340px 1fr; gap:20px;
    }

    /* Card */
    .card {
      background:var(--card); backdrop-filter:blur(12px);
      border-radius:16px; padding:18px;
      box-shadow:0 8px 24px rgba(0,0,0,0.05);
      transition:transform 0.25s ease, box-shadow 0.25s ease;
    }
    .card:hover { transform:translateY(-4px); box-shadow:0 12px 28px rgba(0,0,0,0.08) }

    /* Student carousel */
    .student-carousel { display:flex; gap:14px; overflow-x:auto; padding-bottom:6px }
    .student-card {
      min-width:120px; text-align:center; padding:14px;
      background:rgba(255,255,255,0.6);
      border-radius:14px; cursor:pointer;
      border:2px solid transparent;
      transition:all 0.25s ease;
    }
    .student-card:hover { transform:scale(1.05) }
    .student-card.active {
      border-color:var(--primary);
      box-shadow:0 4px 16px rgba(99,102,241,0.3);
    }
    .student-card img { height:64px;width:64px;border-radius:50%;margin-bottom:8px }
    .student-card h4 { font-size:1rem;margin:0 }

    /* Summary */
    .stat-row { display:flex; justify-content:space-between; padding:8px 0 }
    .stat { display:flex; flex-direction:column }
    .stat .value { font-weight:700; font-size:1.1rem }

    /* Tabs */
    .tabs { display:flex; gap:10px; margin-bottom:14px }
    .tab {
      padding:8px 14px; border-radius:12px;
      border:1px solid #e5e7eb; cursor:pointer;
      transition:all 0.3s;
    }
    .tab.active {
      background:linear-gradient(90deg,var(--primary),var(--primary-2));
      color:white; border:0;
    }

    /* Charts */
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px }
    .chart-wrap { height:220px }

    /* Calendar */
    .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:12px }
    .day-name { font-size:0.78rem; color:var(--muted); text-align:center }
    .day-cell {
      background:#f9fafb; padding:10px; border-radius:10px;
      text-align:center; min-height:72px; position:relative;
      transition:transform 0.2s, box-shadow 0.2s;
    }
    .day-cell:hover { transform:scale(1.05); box-shadow:0 4px 12px rgba(0,0,0,0.08) }
    .day-cell.present { background:linear-gradient(180deg,#dcfce7,#bbf7d0) }
    .day-cell.absent { background:linear-gradient(180deg,#fee2e2,#fecaca) }
    .day-cell .dot { position:absolute; right:8px; top:8px; height:10px; width:10px; border-radius:50% }
    .dot.present { background:var(--success) }
    .dot.absent { background:var(--danger) }

    /* Legend */
    .legend { display:flex; gap:12px; justify-content:center; margin-top:10px }
    .legend-item { display:flex; gap:6px; align-items:center; font-size:0.85rem }

    /* Responsive */
    @media (max-width:1000px) {
      .dashboard-grid { grid-template-columns:1fr }
      .left-col { order:2 } .right-col { order:1 }
    }

    /* Fade animation */
    .fade-in { animation: fadeIn 0.4s ease forwards; }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(8px) }
      to { opacity:1; transform:translateY(0) }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <div class="brand">
        <img id="headerLogo" src="" alt="logo" style="display:none">
        <h1 id="companyName">Parent Dashboard</h1>
      </div>
      <div class="profile-menu">
        <div style="text-align:right">
          <div id="parentName" style="font-weight:700">Parent</div>
          <div id="parentEmail" style="font-size:0.85rem;color:var(--muted)"></div>
        </div>
        <button class="profile-btn" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i></button>
      </div>
    </header>

    <!-- Dashboard -->
    <div class="dashboard-grid">
      <!-- Left -->
      <div class="left-col">
        <div class="card fade-in">
          <h3 style="margin:0 0 10px">Children</h3>
          <div class="student-carousel" id="studentList"></div>
        </div>

        <div class="card fade-in">
          <h4 style="margin:0 0 8px">This Month Summary</h4>
          <div class="stat-row">
            <div class="stat"><span class="label">Present</span><span class="value" id="summaryPresent">—</span></div>
            <div class="stat"><span class="label">Absent</span><span class="value" id="summaryAbsent">—</span></div>
          </div>
          <div style="height:160px"><canvas id="attendanceDonut"></canvas></div>
        </div>

        <div class="card fade-in">
          <h4 style="margin:0 0 8px">Quick Performance</h4>
          <div id="metricList"></div>
        </div>
      </div>

      <!-- Right -->
      <div class="right-col">
        <div class="card fade-in">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <h3 style="margin:0">Overview</h3>
            <div class="tabs">
              <button class="tab active" data-tab="attendance" onclick="switchTab('attendance', this)">
                <i class="fa-regular fa-calendar-days"></i> Attendance
              </button>
              <button class="tab" data-tab="performance" onclick="switchTab('performance', this)">
                <i class="fa-solid fa-chart-line"></i> Performance
              </button>
            </div>
          </div>

          <!-- Attendance Tab -->
          <div id="attendanceTab" class="tab-panel fade-in">
            <div class="grid-2">
              <div class="card">
                <h4 style="margin:0">Monthly Attendance</h4>
                <div class="chart-wrap"><canvas id="miniAttendance"></canvas></div>
              </div>
              <div class="card">
                <h4 style="margin:0">Attendance Trend</h4>
                <div class="chart-wrap"><canvas id="attendanceTrend"></canvas></div>
              </div>
            </div>

            <div style="margin-top:14px">
              <div style="display:flex;align-items:center;justify-content:space-between">
                <div>
                  <button onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                  <strong id="currentMonth"></strong>
                  <button onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div style="color:var(--muted);font-size:0.9rem">Click a day for details</div>
              </div>

              <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px">
                <div class="day-name">Sun</div><div class="day-name">Mon</div><div class="day-name">Tue</div>
                <div class="day-name">Wed</div><div class="day-name">Thu</div><div class="day-name">Fri</div>
                <div class="day-name">Sat</div>
              </div>

              <div class="calendar" id="calendarGrid"></div>

              <div class="legend">
                <div class="legend-item"><span class="legend-box" style="background:var(--success);width:12px;height:12px;border-radius:3px"></span> Present</div>
                <div class="legend-item"><span class="legend-box" style="background:var(--danger);width:12px;height:12px;border-radius:3px"></span> Absent</div>
              </div>
            </div>
          </div>

          <!-- Performance Tab -->
          <div id="performanceTab" class="tab-panel fade-in" style="display:none;margin-top:12px">
            <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
              <div style="flex:1;min-width:260px" class="card">
                <h4 style="margin:0">Metric Averages</h4>
                <div style="height:240px"><canvas id="metricsBar"></canvas></div>
              </div>
              <div style="flex:1;min-width:260px" class="card">
                <h4 style="margin:0">Progress Over Time</h4>
                <div style="height:240px"><canvas id="metricsLine"></canvas></div>
              </div>
            </div>

            <div style="margin-top:12px" class="card">
              <h4 style="margin:0 0 8px">Latest Notes</h4>
              <div id="notesList"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts (unchanged backend logic) -->
  <script>
    const SUPABASE_URL = "https://ndishfwnkzdedfcywcle.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let sessionUser=null, students=[], activeStudent=null, currentMonth=dayjs();
let donutChart=null, miniChart=null, trendChart=null, metricsBar=null, metricsLine=null;

async function init(){
  try {
    const { data: { session }, error } = await supabase.auth.getSession();
    if(error || !session){ window.location.href = 'index.html'; return; }
    sessionUser = session.user;
    document.getElementById('parentName').textContent = sessionUser.user_metadata?.full_name || sessionUser.email.split('@')[0];
    document.getElementById('parentEmail').textContent = sessionUser.email;

    // Load company + children
    const { data: userData, error: userError } = await supabase
      .from('users')
      .select('company_id, role, companies(display_name, logo_url)')
      .eq('id', sessionUser.id)
      .maybeSingle();
    if(userError || !userData || userData.role!=='parent'){ window.location.href='index.html'; return; }
    if(userData.companies?.display_name) document.getElementById('companyName').textContent = userData.companies.display_name;
    if(userData.companies?.logo_url){ const e=document.getElementById('headerLogo'); e.src=userData.companies.logo_url; e.style.display='inline-block' }

    loadStudents();
  } catch(err){ console.error("Init error:",err); }
}

async function loadStudents(){
  try {
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    if (sessionError || !session) { window.location.href = "index.html"; return; }
    const user = session.user;

    const { data: userData, error: userError } = await supabase
      .from('users')
      .select('company_id, role')
      .eq('id', user.id)
      .maybeSingle();
    if (userError || !userData) { console.error("User fetch error:", userError); return; }
    if (userData.role !== 'parent') { window.location.href = "index.html"; return; }

    const { data: studentData, error: studentError } = await supabase
      .from('students')
      .select('id, name, parent_email, company_id, classes:class_id(name)')
      .ilike('parent_email', user.email) 
      .eq('company_id', userData.company_id);
    if (studentError) { console.error("Error fetching student data:", studentError); return; }

    students = studentData || [];
    if (students.length > 0) {
      renderStudentCarousel();
      setActiveStudent(students[0]);
    } else {
      document.getElementById("studentList").innerHTML = "<p>No students found linked to this account.</p>";
    }
  } catch(err){ console.error("Load students error:",err); }
}

function renderStudentCarousel(){
  const el = document.getElementById('studentList'); el.innerHTML='';
  students.forEach(s=>{
    const card = document.createElement('div'); card.className='student-card';
    card.innerHTML = `<img src='https://ui-avatars.com/api/?name=${encodeURIComponent(s.name)}&background=ddd&color=555&rounded=true' alt=''> 
                      <h4>${s.name}</h4>
                      <div style='font-size:0.8rem;color:var(--muted)'>${s.classes?.name||''}</div>`;
    card.onclick = ()=> setActiveStudent(s);
    el.appendChild(card);
  });
}

function setActiveStudent(s){
  activeStudent = s;
  document.querySelectorAll('.student-card').forEach((c,i)=> c.classList.toggle('active', students[i].id===s.id));
  refreshAll();
}

async function refreshAll(){
  if(!activeStudent) return;
  await renderAttendanceSummary();
  await renderAttendanceCharts();
  await renderCalendar();
  await renderPerformance();
}

async function renderAttendanceSummary() {
  try {
    const start = currentMonth.startOf('month').format('YYYY-MM-DD');
    const end = currentMonth.endOf('month').format('YYYY-MM-DD');
    const { data: attendanceData, error: attendanceError } = await supabase
      .from('attendance')
      .select('date,status')
      .eq('student_id', activeStudent.id)
      .gte('date', start).lte('date', end);
    if (attendanceError) { console.error(attendanceError); return; }

    const present = (attendanceData || []).filter(r => r.status === 'Present').length;
    const absent = (attendanceData || []).filter(r => r.status === 'Absent').length;
    document.getElementById('summaryPresent').textContent = present;
    document.getElementById('summaryAbsent').textContent = absent;

    const ctx = document.getElementById('attendanceDonut').getContext('2d');
    if (donutChart) donutChart.destroy();
    donutChart = new Chart(ctx, {
      type: 'doughnut',
      data: { labels: ['Present', 'Absent'], datasets: [{ data: [present, absent], backgroundColor: ['#34d399', '#fb7185'] }] },
      options: { plugins: { legend: { position: 'bottom' } } }
    });
  } catch(err){ console.error("Attendance summary error:",err); }
}

async function renderAttendanceCharts(){
  try {
    const start = currentMonth.startOf('month').format('YYYY-MM-DD');
    const end = currentMonth.endOf('month').format('YYYY-MM-DD');
    const { data } = await supabase.from('attendance')
      .select('date,status')
      .eq('student_id', activeStudent.id).gte('date', start).lte('date', end);

    // Mini chart: presence per weekday
    const days = Array(7).fill(0);
    (data||[]).forEach(r=>{ const dow = dayjs(r.date).day(); if(r.status==='Present') days[dow]++; });
    const ctx = document.getElementById('miniAttendance').getContext('2d'); if(miniChart) miniChart.destroy();
    miniChart = new Chart(ctx, {type:'bar', data:{labels:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'], datasets:[{label:'Present', data:days, backgroundColor:'#60a5fa'}]}, options:{plugins:{legend:{display:false}}}});

    // Trend chart
    const dayCount = currentMonth.daysInMonth();
    const labels = Array.from({length:dayCount},(_,i)=>i+1);
    const counts = Array(dayCount).fill(0);
    (data||[]).forEach(r=>{ const d = dayjs(r.date).date(); if(r.status==='Present') counts[d-1]=1; });
    const ctx2 = document.getElementById('attendanceTrend').getContext('2d'); if(trendChart) trendChart.destroy();
    trendChart = new Chart(ctx2, {type:'line', data:{labels, datasets:[{label:'Present', data:counts, borderColor:'#34d399'}]}, options:{scales:{y:{beginAtZero:true,max:1}}}});
  } catch(err){ console.error("Attendance charts error:",err); }
}

async function renderCalendar(){
  try {
    const start = currentMonth.startOf('month').format('YYYY-MM-DD');
    const end = currentMonth.endOf('month').format('YYYY-MM-DD');
    const { data } = await supabase.from('attendance')
      .select('date,status')
      .eq('student_id', activeStudent.id).gte('date', start).lte('date', end);

    document.getElementById('currentMonth').textContent = currentMonth.format('MMMM YYYY');
    const firstDay = currentMonth.startOf('month').day();
    const dayCount = currentMonth.daysInMonth();
    const grid = document.getElementById('calendarGrid'); grid.innerHTML='';
    for(let i=0;i<firstDay;i++){ const cell=document.createElement('div'); grid.appendChild(cell); }
    for(let d=1;d<=dayCount;d++){
      const date = currentMonth.date(d).format('YYYY-MM-DD');
      const record = (data||[]).find(r=>r.date===date);
      const cell=document.createElement('div'); cell.className='day-cell';
      cell.textContent = d;
      if(record){
        if(record.status==='Present'){ cell.classList.add('present'); const dot=document.createElement('span'); dot.className='dot present'; cell.appendChild(dot); }
        else if(record.status==='Absent'){ cell.classList.add('absent'); const dot=document.createElement('span'); dot.className='dot absent'; cell.appendChild(dot); }
      }
      grid.appendChild(cell);
    }
  } catch(err){ console.error("Calendar error:",err); }
}

async function renderPerformance() {
  try {
    // Get metric definitions
    const { data: metrics, error: metricsError } = await supabase
      .from("performance_metrics")
      .select("id,name");
    if (metricsError) throw metricsError;

    // First, fetch performance_records (try with relation, fallback if error)
    let records = [];
    let { data: recordsData, error: recordsError } = await supabase
  .from("performance_records")
  .select(`
    score, notes, created_at, metric_id,
    attendance:attendance_id (
      date,
      student_id
    )
  `)
  .eq("attendance.student_id", activeStudent.id);


    if (recordsError) {
      console.warn("No relation available for attendance. Falling back…", recordsError.message);
      const { data: fallbackData, error: fallbackError } = await supabase
        .from("performance_records")
        .select("score, notes, created_at, metric_id, attendance_id")
        .eq("student_id", activeStudent.id);
      if (fallbackError) throw fallbackError;
      recordsData = fallbackData;
    }
    records = recordsData || [];

    // Quick metrics (averages)
    const list = document.getElementById("metricList");
    list.innerHTML = "";
    metrics.forEach((m) => {
      const scores = records.filter((r) => r.metric_id === m.id).map((r) => r.score);
      const avg = scores.length
        ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1)
        : "—";
      const div = document.createElement("div");
      div.textContent = `${m.name}: ${avg}`;
      list.appendChild(div);
    });

    // Bar chart (averages)
    const labels = metrics.map((m) => m.name);
    const avgs = metrics.map((m) => {
      const scores = records.filter((r) => r.metric_id === m.id).map((r) => r.score);
      return scores.length ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
    });
    const ctx = document.getElementById("metricsBar").getContext("2d");
    if (metricsBar) metricsBar.destroy();
    metricsBar = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [{ label: "Average", data: avgs, backgroundColor: "#a78bfa" }] },
    });

    // Line chart (weekly averages per metric)
    const weeks = [];
    let weekStart = dayjs().subtract(11, "week").startOf("week");
    for (let i = 0; i < 12; i++) weeks.push(weekStart.add(i, "week"));

    const datasets = metrics.map((m) => {
      const points = weeks.map((ws) => {
        const we = ws.endOf("week");
        const wkRecords = records.filter(
          (r) =>
            r.metric_id === m.id &&
            dayjs(r.created_at).isAfter(ws) &&
            dayjs(r.created_at).isBefore(we)
        );
        if (wkRecords.length === 0) return null;
        const avg = wkRecords.reduce((a, b) => a + b.score, 0) / wkRecords.length;
        return Number(avg.toFixed(1));
      });
      return {
        label: m.name,
        data: points,
        borderColor: `hsl(${Math.random() * 360},70%,50%)`,
        tension: 0.3,
      };
    });

    const ctx2 = document.getElementById("metricsLine").getContext("2d");
    if (metricsLine) metricsLine.destroy();
    metricsLine = new Chart(ctx2, {
      type: "line",
      data: { labels: weeks.map((w) => w.format("MMM D")), datasets },
    });

    // Notes section
    const notesList = document.getElementById("notesList");
    notesList.innerHTML = "";
    records
      .filter((r) => r.notes)
      .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
      .slice(0, 5)
      .forEach((r) => {
        const note = document.createElement("div");
        note.style.marginBottom = "6px";
        note.textContent = `${dayjs(r.created_at).format("MMM D")}: ${r.notes}`;
        notesList.appendChild(note);
      });
  } catch (err) {
    console.error("Performance error:", err);
  }
}


function switchTab(tab, btn){
  document.getElementById('attendanceTab').style.display=tab==='attendance'?'block':'none';
  document.getElementById('performanceTab').style.display=tab==='performance'?'block':'none';
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active');
}

function changeMonth(delta){ currentMonth=currentMonth.add(delta,'month'); refreshAll(); }
function logout(){ supabase.auth.signOut().then(()=>window.location.href='index.html'); }

window.onload = init;
  </script>
</body>
</html>
