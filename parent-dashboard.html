<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Parent Dashboard</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_isoWeek)</script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f4f8;
      color: #333;
    }
    header {
      background: #007bff;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      padding: 1rem;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .flex {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .chart-box {
      flex: 1;
      min-width: 280px;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 1rem;
    }
    .day {
      padding: 8px;
      border-radius: 8px;
      background: #f7f7f7;
      text-align: center;
    }
    .present { background: #28a745 !important; color: white; }
    .absent { background: #dc3545 !important; color: white; }
    .logout {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="companyName">Parent Dashboard</h1>
  </header>

  <div class="container">
    <!-- Student Selector -->
    <div class="card">
      <label for="studentSelector">Select Student:</label>
      <select id="studentSelector"></select>
      <div id="studentInfo"></div>
    </div>

    <!-- Attendance Section -->
    <div class="card">
      <h2>Attendance</h2>
      <div class="flex">
        <div class="chart-box">
          <canvas id="attendanceDonut"></canvas>
        </div>
        <div class="chart-box">
          <canvas id="attendanceTrend"></canvas>
        </div>
      </div>
      <div>
        <h3 id="currentMonth"></h3>
        <div id="calendar"></div>
      </div>
    </div>

    <!-- Performance Section -->
    <div class="card">
      <h2>Performance</h2>
      <div class="chart-box">
        <canvas id="performanceRadar"></canvas>
      </div>
    </div>

    <!-- Logout -->
    <div class="card">
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://YOUR_PROJECT.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let sessionUser = null;
    let companyId = null;
    let students = [];
    let activeStudent = null;
    let currentMonth = dayjs();

    let attendanceDonutChart, attendanceTrendChart, performanceRadarChart;

    // ================== INIT ==================
    async function init() {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error || !session) {
        window.location.href = "index.html";
        return;
      }
      sessionUser = session.user;

      // Get user company
      const { data: userData } = await supabase
        .from("users")
        .select("company_id, role, companies(display_name)")
        .eq("id", sessionUser.id)
        .maybeSingle();

      if (!userData || userData.role !== "parent") {
        window.location.href = "home.html";
        return;
      }
      companyId = userData.company_id;
      document.getElementById("companyName").textContent = userData.companies.display_name;

      await loadStudents();
    }

    // ================== STUDENTS ==================
    async function loadStudents() {
      const { data, error } = await supabase.from("students")
        .select("id, name, parent_email, class_id, classes(name)")
        .eq("parent_email", sessionUser.email.toLowerCase())
        .eq("company_id", companyId);

      if (error) {
        console.error("Students Error:", error);
        return;
      }
      students = data || [];

      const sel = document.getElementById("studentSelector");
      sel.innerHTML = students.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
      sel.onchange = e => {
        activeStudent = students.find(s => s.id == e.target.value);
        updateStudent();
      };

      if (students.length > 0) {
        activeStudent = students[0];
        sel.value = activeStudent.id;
        updateStudent();
      }
    }

    function updateStudent() {
      document.getElementById("studentInfo").innerHTML =
        `<p><strong>${activeStudent.name}</strong> â€” Class: ${activeStudent.classes?.name || "N/A"}</p>`;
      renderAttendance();
      renderPerformance();
    }

    // ================== ATTENDANCE ==================
    async function renderAttendance() {
      if (!activeStudent) return;

      const start = currentMonth.startOf("month").format("YYYY-MM-DD");
      const end = currentMonth.endOf("month").format("YYYY-MM-DD");

      const { data, error } = await supabase.from("attendance")
        .select("id, status, \"date\"")
        .eq("student_id", activeStudent.id)
        .eq("company_id", companyId)
        .gte("\"date\"", start)
        .lte("\"date\"", end);

      if (error) {
        console.error("Attendance Error:", error);
        return;
      }

      const present = data.filter(r => r.status === "Present").length;
      const absent = data.filter(r => r.status === "Absent").length;

      // Donut chart
      if (attendanceDonutChart) attendanceDonutChart.destroy();
      attendanceDonutChart = new Chart(document.getElementById("attendanceDonut"), {
        type: "doughnut",
        data: {
          labels: ["Present", "Absent"],
          datasets: [{ data: [present, absent], backgroundColor: ["#28a745", "#dc3545"] }]
        }
      });

      // Trend chart
      const grouped = {};
      data.forEach(r => {
        grouped[r.date] = (grouped[r.date] || 0) + (r.status === "Present" ? 1 : 0);
      });
      const labels = Object.keys(grouped).sort();
      const values = labels.map(l => grouped[l]);

      if (attendanceTrendChart) attendanceTrendChart.destroy();
      attendanceTrendChart = new Chart(document.getElementById("attendanceTrend"), {
        type: "line",
        data: { labels, datasets: [{ label: "Presence", data: values, borderColor: "#007bff" }] }
      });

      // Calendar
      renderCalendar(data);
    }

    function renderCalendar(records) {
      const cal = document.getElementById("calendar");
      cal.innerHTML = "";
      document.getElementById("currentMonth").textContent = currentMonth.format("MMMM YYYY");

      const startDay = currentMonth.startOf("month").day();
      const daysInMonth = currentMonth.daysInMonth();

      for (let i=0; i<startDay; i++) {
        cal.appendChild(document.createElement("div"));
      }

      for (let d=1; d<=daysInMonth; d++) {
        const dateStr = currentMonth.date(d).format("YYYY-MM-DD");
        const rec = records.find(r => r.date === dateStr);
        const div = document.createElement("div");
        div.className = "day";
        div.textContent = d;
        if (rec?.status === "Present") div.classList.add("present");
        if (rec?.status === "Absent") div.classList.add("absent");
        cal.appendChild(div);
      }
    }

    // ================== PERFORMANCE ==================
    async function renderPerformance() {
      if (!activeStudent) return;

      const { data, error } = await supabase.from("performance_records")
        .select("score, attendance(date), metric:metric_id(name)")
        .eq("attendance.student_id", activeStudent.id)
        .eq("attendance.company_id", companyId);

      if (error) {
        console.error("Performance Error:", error);
        return;
      }

      const grouped = {};
      data.forEach(r => {
        if (!grouped[r.metric.name]) grouped[r.metric.name] = [];
        grouped[r.metric.name].push(r.score);
      });

      const labels = Object.keys(grouped);
      const averages = labels.map(l => {
        const arr = grouped[l];
        return arr.reduce((a,b)=>a+b,0)/arr.length;
      });

      if (performanceRadarChart) performanceRadarChart.destroy();
      performanceRadarChart = new Chart(document.getElementById("performanceRadar"), {
        type: "radar",
        data: { labels, datasets: [{ label: "Avg Score", data: averages, backgroundColor: "rgba(0,123,255,0.2)", borderColor: "#007bff" }] }
      });
    }

    // ================== LOGOUT ==================
    async function logout() {
      await supabase.auth.signOut();
      window.location.href = "index.html";
    }

    window.onload = init;
  </script>
</body>
</html>
