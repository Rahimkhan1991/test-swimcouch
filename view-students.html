<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>View Students</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    :root {
      --primary: #6366F1;
      --primary-dark: #4f46e5;
      --bg: #f4f6fa;
      --card-bg: #fff;
      --text: #333;
      --muted: #777;
      --shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    }
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
      padding-bottom: 120px;
    }
    .container { max-width: 85%; margin: 0 auto; }
    h2 { text-align: center; color: var(--primary); margin: 0 0 20px; }

    /* Search */
    .search-container { position: relative; margin-bottom: 15px; }
    .search-container input {
      width: 92%; padding: 12px 40px 12px 15px;
      border-radius: 25px; border: 1px solid #ddd; font-size: 1rem;
    }
    .search-container .fa-search {
      position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--muted);
    }

    /* Filters */
    .class-filter-container { display: flex; overflow-x: auto; padding: 10px 0; gap: 10px; margin-bottom: 20px; }
    .class-filter-btn {
      flex-shrink: 0; padding: 6px 14px; border-radius: 20px; border: 1px solid #ddd;
      background: var(--card-bg); cursor: pointer; font-size: 0.9rem; transition: 0.2s;
    }
    .class-filter-btn.active, .class-filter-btn:hover {
      background: var(--primary); color: #fff; border-color: var(--primary);
    }

    /* Student cards */
    .student-card {
      background: var(--card-bg); padding: 15px 20px; border-radius: 12px;
      box-shadow: var(--shadow); margin-bottom: 15px; display: flex; justify-content: space-between;
      cursor: pointer; transition: transform 0.2s;
    }
    .student-card:hover { transform: translateY(-2px); }
    .student-info .student-name { font-size: 1.1rem; font-weight: 600; color: var(--primary); margin: 0; }
    .student-info .details-summary { font-size: 0.9rem; color: var(--muted); }

    /* Loading state */
    .loading { text-align: center; padding: 20px; color: var(--muted); }

    /* Fixed bottom stacked buttons */
    .fixed-bottom-buttons {
      position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
      display: flex; flex-direction: column; align-items: center; gap: 12px; z-index: 200;
    }
    .fixed-bottom-buttons button {
      width: 90vw; max-width: 400px; padding: 14px; border: none; border-radius: 10px;
      cursor: pointer; font-size: 1rem; font-weight: 600; text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: background 0.3s;
      background: var(--primary); color: #fff;
    }
    .fixed-bottom-buttons button:hover { background: var(--primary-dark); }

    /* Modals */
    .modal {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
      justify-content: center; align-items: center; z-index: 100; padding: 10px;
    }
    .modal-content {
      background: var(--card-bg); padding: 20px; border-radius: 12px;
      max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative;
    }
    .modal-content h3 { text-align: center; margin-top: 0; color: var(--primary); }
    .modal-details p { margin: 6px 0; }

    /* Inputs */
    input[type="text"], input[type="number"] {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 12px;
    }

    /* Buttons inside modals */
    .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .modal-buttons button { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; min-width: 100px; }
    .close-btn { background: #ccc; }
    .save-btn { background: var(--primary); color: #fff; }
    .edit-btn { background: #ffc107; }
    .delete-btn { background: #dc3545; color: #fff; }

    /* Toasts */
    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--primary); color: #fff; padding: 12px 20px; border-radius: 8px;
      box-shadow: var(--shadow); opacity: 0; pointer-events: none; transition: opacity 0.3s, transform 0.3s; z-index: 200;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); pointer-events: auto; }

    @media(max-width:600px) {
      body { padding: 10px; }
      .student-card { flex-direction: column; align-items: flex-start; }
      .modal-content { padding: 15px; }
      .modal-buttons { flex-direction: column; }
      .modal-buttons button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Student List</h2>

    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Search by name...">
      <i class="fa fa-search"></i>
    </div>

    <div id="classFilterContainer" class="class-filter-container"></div>
    <div id="studentList"></div>
  </div>

  <!-- Student Details Modal -->
  <div id="studentDetailsModal" class="modal">
    <div class="modal-content">
      <h3 id="modalStudentName">Details</h3>
      <div id="modalDetails" class="modal-details"></div>
      <div class="modal-buttons">
        <button class="delete-btn" id="deleteBtn"><i class="fa fa-trash"></i> Delete</button>
        <button class="edit-btn" id="editBtn"><i class="fa fa-pen"></i> Edit</button>
        <button class="close-btn" id="closeDetailsBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editFormModal" class="modal">
    <div class="modal-content">
      <h3>Edit Student</h3>
      <input type="text" id="editName" placeholder="Name">
      <input type="text" id="editPhone" placeholder="Phone">
      <input type="number" id="editTotalFee" placeholder="Total Fee">
      <input type="number" id="editInitialPayment" placeholder="Initial Payment">
      <div id="editDaysCheckboxes">
        <label><input type="checkbox" value="Monday"> Mon</label>
        <label><input type="checkbox" value="Tuesday"> Tue</label>
        <label><input type="checkbox" value="Wednesday"> Wed</label>
        <label><input type="checkbox" value="Thursday"> Thu</label>
        <label><input type="checkbox" value="Friday"> Fri</label>
        <label><input type="checkbox" value="Saturday"> Sat</label>
        <label><input type="checkbox" value="Sunday"> Sun</label>
      </div>
      <div class="modal-buttons">
        <button class="close-btn" id="cancelEditBtn">Cancel</button>
        <button class="save-btn" id="saveEditBtn"><i class="fa fa-save"></i> Save</button>
      </div>
    </div>
  </div>

  <!-- Fixed bottom buttons -->
  <div class="fixed-bottom-buttons">
    <button class="back-btn" id="backBtn"><i class="fa fa-arrow-left"></i> Back</button>
    <button class="add-student-btn" id="addStudentBtn"><i class="fa fa-plus"></i> Add Student</button>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    const SUPABASE_URL = "https://ndishfwnkzdedfcywcle.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentStudentId = null;
    let selectedClassId = null;
    let debounceTimer = null;

    const searchInput = document.getElementById("searchInput");
    const studentList = document.getElementById("studentList");
    const classFilterContainer = document.getElementById("classFilterContainer");
    const studentDetailsModal = document.getElementById("studentDetailsModal");
    const modalStudentName = document.getElementById("modalStudentName");
    const modalDetails = document.getElementById("modalDetails");
    const editFormModal = document.getElementById("editFormModal");
    const toast = document.getElementById("toast");

    /* ---------- Helpers ---------- */
    function showToast(msg, success = true) {
      toast.textContent = msg;
      toast.style.background = success ? "var(--primary)" : "#dc3545";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }
    function formatDays(days) {
      if (!days) return "N/A";
      return Array.isArray(days) ? days.join(", ") : days.toString();
    }
    async function fetchData(queryFn) {
      try {
        const { data, error } = await queryFn;
        if (error) throw error;
        return data;
      } catch (err) {
        console.error(err.message);
        showToast("Error loading data", false);
        return null;
      }
    }

    /* ---------- Session ---------- */
    async function checkUserSession() {
      try {
        const { data, error } = await supabase.auth.getSession();
        if (error || !data?.session) window.location.href = "index.html";
      } catch {
        window.location.href = "index.html";
      }
    }

    /* ---------- Render Students ---------- */
    async function renderStudents(search = "", classId = null) {
      studentList.innerHTML = `<p class="loading">Loading students...</p>`;

      let query = supabase.from("students").select("*, classes(name)").order("name");
      if (search) query = query.ilike("name", `%${search}%`);
      if (classId) query = query.eq("class_id", classId);

      const students = await fetchData(query);
      if (!students?.length) {
        studentList.innerHTML = "<p>No students found.</p>";
        return;
      }

      const fees = await fetchData(supabase.from("fees").select("student_id, amount"));
      const feeMap = {};
      fees?.forEach(f => feeMap[f.student_id] = (feeMap[f.student_id] || 0) + f.amount);

      studentList.innerHTML = "";
      students.forEach(s => {
        const card = document.createElement("div");
        card.className = "student-card";
        card.onclick = () => openStudentDetails(s, feeMap);
        card.innerHTML = `
          <div class="student-info">
            <p class="student-name">${s.name}</p>
            <p class="details-summary">
              Class: ${s.classes?.name || "N/A"} | Days: ${formatDays(s.day)}
            </p>
          </div>
        `;
        studentList.appendChild(card);
      });
    }

    /* ---------- Render Class Filters ---------- */
    async function renderClassFilters() {
      classFilterContainer.innerHTML = "";
      const classes = await fetchData(supabase.from("classes").select("id, name"));

      const allBtn = document.createElement("button");
      allBtn.textContent = "All";
      allBtn.className = "class-filter-btn active";
      allBtn.onclick = () => { selectedClassId = null; setActiveFilter(allBtn); renderStudents(searchInput.value); };
      classFilterContainer.appendChild(allBtn);

      classes?.forEach(c => {
        const btn = document.createElement("button");
        btn.textContent = c.name;
        btn.className = "class-filter-btn";
        btn.onclick = () => {
          selectedClassId = c.id;
          setActiveFilter(btn);
          renderStudents(searchInput.value, selectedClassId);
        };
        classFilterContainer.appendChild(btn);
      });
    }
    function setActiveFilter(btn) {
      document.querySelectorAll(".class-filter-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    }

    /* ---------- Modals ---------- */
    function openStudentDetails(student, feeMap) {
      currentStudentId = student.id;
      modalStudentName.textContent = student.name;
      const totalPaid = feeMap[student.id] || 0;
      const total = +student.totalFee || 0;
      const balance = Math.max(total - totalPaid, 0);

      modalDetails.innerHTML = `
        <p><strong>Phone:</strong> ${student.phone}</p>
        <p><strong>Class:</strong> ${student.classes?.name || "N/A"}</p>
        <p><strong>Days:</strong> ${formatDays(student.day)}</p>
        <p><strong>Total Fee:</strong> ${total}</p>
        <p><strong>Paid:</strong> ${totalPaid}</p>
        <p><strong>Balance:</strong> ${balance}</p>
      `;
      studentDetailsModal.style.display = "flex";
    }
    async function openEditForm() {
      studentDetailsModal.style.display = "none";
      editFormModal.style.display = "flex";
      const student = await fetchData(supabase.from("students").select("*").eq("id", currentStudentId).single());
      if (!student) return;

      document.getElementById("editName").value = student.name || "";
      document.getElementById("editPhone").value = student.phone || "";
      document.getElementById("editTotalFee").value = student.totalFee || "";
      document.getElementById("editInitialPayment").value = student.initialPayment || "";

      document.querySelectorAll("#editDaysCheckboxes input").forEach(cb => cb.checked = false);
      (Array.isArray(student.day) ? student.day : [student.day]).filter(Boolean).forEach(d => {
        const cb = document.querySelector(`#editDaysCheckboxes input[value="${d}"]`);
        if (cb) cb.checked = true;
      });
    }
    async function saveEdit() {
      const updated = {
        name: document.getElementById("editName").value,
        phone: document.getElementById("editPhone").value,
        totalFee: +document.getElementById("editTotalFee").value || 0,
        initialPayment: +document.getElementById("editInitialPayment").value || 0,
      };
      updated.balanceFee = (updated.totalFee || 0) - (updated.initialPayment || 0);
      updated.day = Array.from(document.querySelectorAll("#editDaysCheckboxes input:checked")).map(cb => cb.value);

      const { error } = await supabase.from("students").update(updated).eq("id", currentStudentId);
      if (error) return showToast("Error updating student", false);

      showToast("Student updated!");
      editFormModal.style.display = "none";
      renderStudents(searchInput.value, selectedClassId);
    }
    async function deleteStudent() {
      if (!confirm("Are you sure you want to delete this student?")) return;
      const { error } = await supabase.from("students").delete().eq("id", currentStudentId);
      if (error) return showToast("Delete failed", false);
      showToast("Student deleted");
      studentDetailsModal.style.display = "none";
      renderStudents(searchInput.value, selectedClassId);
    }

    /* ---------- Event Bindings ---------- */
    document.getElementById("closeDetailsBtn").onclick = () => studentDetailsModal.style.display = "none";
    document.getElementById("editBtn").onclick = openEditForm;
    document.getElementById("cancelEditBtn").onclick = () => editFormModal.style.display = "none";
    document.getElementById("saveEditBtn").onclick = saveEdit;
    document.getElementById("deleteBtn").onclick = deleteStudent;
    document.getElementById("backBtn").onclick = () => window.history.back();
    document.getElementById("addStudentBtn").onclick = () => window.location.href = "add-student.html";

    // Search debounce
    searchInput.addEventListener("input", e => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => renderStudents(e.target.value, selectedClassId), 300);
    });

    // Modal close on overlay or ESC
    [studentDetailsModal, editFormModal].forEach(modal => {
      modal.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });
    });
    document.addEventListener("keydown", e => {
      if (e.key === "Escape") {
        studentDetailsModal.style.display = "none";
        editFormModal.style.display = "none";
      }
    });

    /* ---------- Init ---------- */
    checkUserSession();
    renderClassFilters();
    renderStudents();
  </script>
</body>
</html>
