<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>View Students</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --background-color: #f0f4f8;
            --card-background: #ffffff;
            --text-color: #333;
            --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 8px 16px rgba(0, 0, 0, 0.1);
            --input-background: #f7f7f7;
            --input-border: #ddd;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        h2 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.75rem;
        }

        /* --- New Search Bar & Class Filters --- */
        .search-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }

        .search-container input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border-radius: 25px;
            border: 1px solid #ccc;
            font-size: 1rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            box-sizing: border-box;
        }

        .search-container .fa-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }

        .class-filter-container {
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 0;
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .class-filter-container::-webkit-scrollbar {
            display: none;
        }

        .class-filter-btn {
            background-color: var(--card-background);
            border: 1px solid #ccc;
            border-radius: 20px;
            padding: 8px 16px;
            margin-right: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: inline-block;
            color: var(--text-color);
        }

        .class-filter-btn.active, .class-filter-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-light);
        }

        /* --- Simplified Student List Cards --- */
        .student-card {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .student-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .student-info .student-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }

        .student-info .details-summary {
            font-size: 0.9rem;
            color: #777;
        }

        /* --- Buttons --- */
        .back-button {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .back-button:hover {
            background-color: #0056b3;
        }

        /* --- Modal Styles --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .modal-content {
            background-color: var(--card-background);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-hover);
            width: 90%;
            max-width: 450px;
        }

        .modal-content h3 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .modal-details p {
            font-size: 1rem;
            line-height: 1.6;
            margin: 0 0 10px;
        }

        .modal-details p strong {
            color: var(--primary-color);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            width: auto;
        }

        .close-btn {
            background-color: #ccc;
            color: #333;
        }

        .edit-btn {
            background-color: #ffc107;
            color: #333;
        }

        .delete-btn {
            background-color: #dc3545;
            color: #fff;
        }

        /* --- Responsive Styles --- */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { max-width: 100%; }
            .search-container input { padding: 12px 35px 12px 12px; }
            h2 { font-size: 1.5rem; }
            .student-card { padding: 15px; }
            .modal-content { padding: 20px; }
            .modal-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Student List</h2>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search by name...">
            <i class="fa-solid fa-search"></i>
        </div>

        <div class="class-filter-container" id="classFilterContainer">
            </div>

        <div id="studentList">
            </div>
        
        <button onclick="history.back()" class="back-button"><i class="fa-solid fa-arrow-left"></i> Back</button>
    </div>

    <div id="studentDetailsModal" class="modal">
        <div class="modal-content">
            <h3 id="modalStudentName">Student Details</h3>
            <div id="modalDetails" class="modal-details">
                </div>
            <div class="modal-buttons">
                <button class="delete-btn" onclick="deleteStudent()"><i class="fa-solid fa-trash-can"></i> Delete</button>
                <button class="edit-btn" onclick="openEditMode()"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
                <button class="close-btn" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="editFormModal" class="modal">
        <div class="modal-content">
            <h3>Edit Student</h3>
            <label>Name</label>
            <input type="text" id="editName" placeholder="Name">
            <label>Phone</label>
            <input type="text" id="editPhone" placeholder="Phone">
            <label>Total Fee</label>
            <input type="number" id="editTotalFee" placeholder="Total Fee">
            <label>Initial Payment</label>
            <input type="number" id="editInitialPayment" placeholder="Initial Payment">
            <label>Assigned Days</label>
            <div class="days-checkboxes" id="editDaysCheckboxes">
                <label><input type="checkbox" value="Monday"> Mon</label>
                <label><input type="checkbox" value="Tuesday"> Tue</label>
                <label><input type="checkbox" value="Wednesday"> Wed</label>
                <label><input type="checkbox" value="Thursday"> Thu</label>
                <label><input type="checkbox" value="Friday"> Fri</label>
                <label><input type="checkbox" value="Saturday"> Sat</label>
                <label><input type="checkbox" value="Sunday"> Sun</label>
            </div>
            <div class="modal-buttons">
                <button class="close-btn" onclick="closeEditFormModal()">Cancel</button>
                <button class="save-btn" onclick="saveEdit()"><i class="fa-solid fa-floppy-disk"></i> Save</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ndishfwnkzdedfcywcle.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentStudentId = null;
        let selectedClassId = null;
        let debounceTimer = null;

        async function checkUserSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
            }
        }
        checkUserSession();

        async function renderStudents(searchQuery = '', classFilterId = null) {
            const studentList = document.getElementById("studentList");
            studentList.innerHTML = "";

            let query = supabase
                .from('students')
                .select('*, classes(name)')
                .order('name', { ascending: true });

            if (searchQuery) {
                query = query.ilike('name', `%${searchQuery}%`);
            }
            if (classFilterId) {
                query = query.eq('class_id', classFilterId);
            }

            const { data: students, error: studentsError } = await query;
            
            if (studentsError) {
                console.error('Error fetching students:', studentsError.message);
                studentList.innerHTML = '<p>Error loading students.</p>';
                return;
            }

            if (students.length === 0) {
                studentList.innerHTML = '<p>No students found.</p>';
                return;
            }

            const { data: fees, error: feesError } = await supabase.from('fees').select('student_id, amount');
            const feeMap = {};
            if (fees) {
                fees.forEach(fee => {
                    feeMap[fee.student_id] = (feeMap[fee.student_id] || 0) + fee.amount;
                });
            }

            students.forEach(student => {
                const card = document.createElement("div");
                card.className = "student-card";
                card.onclick = () => openStudentDetailsModal(student.id, student, feeMap);
                
                const studentInfo = document.createElement("div");
                studentInfo.className = "student-info";
                
                const studentName = document.createElement("p");
                studentName.className = "student-name";
                studentName.textContent = student.name;
                
                const summaryDetails = document.createElement("p");
                summaryDetails.className = "details-summary";
                const className = student.classes ? student.classes.name : 'N/A';
                const days = Array.isArray(student.day) ? student.day.join(', ') : 'N/A';
                summaryDetails.innerHTML = `Class: ${className} | Days: ${days}`;

                studentInfo.appendChild(studentName);
                studentInfo.appendChild(summaryDetails);
                card.appendChild(studentInfo);
                studentList.appendChild(card);
            });
        }

        async function renderClassFilters() {
            const classFilterContainer = document.getElementById('classFilterContainer');
            classFilterContainer.innerHTML = '';
            
            const { data: classes, error } = await supabase.from('classes').select('id, name');
            if (error) {
                console.error('Error fetching classes:', error.message);
                return;
            }

            const allBtn = document.createElement('button');
            allBtn.className = 'class-filter-btn active';
            allBtn.textContent = 'All Students';
            allBtn.onclick = () => {
                selectedClassId = null;
                document.querySelectorAll('.class-filter-btn').forEach(btn => btn.classList.remove('active'));
                allBtn.classList.add('active');
                renderStudents(document.getElementById('searchInput').value);
            };
            classFilterContainer.appendChild(allBtn);

            classes.forEach(cls => {
                const btn = document.createElement('button');
                btn.className = 'class-filter-btn';
                btn.textContent = cls.name;
                btn.onclick = () => {
                    selectedClassId = cls.id;
                    document.querySelectorAll('.class-filter-btn').forEach(btn => btn.classList.remove('active'));
                    btn.classList.add('active');
                    renderStudents(document.getElementById('searchInput').value, selectedClassId);
                };
                classFilterContainer.appendChild(btn);
            });
        }

        async function openStudentDetailsModal(studentId, studentData = null, feeMap = null) {
            currentStudentId = studentId;
            const studentDetailsModal = document.getElementById("studentDetailsModal");
            const modalStudentName = document.getElementById("modalStudentName");
            const modalDetails = document.getElementById("modalDetails");
            
            let student = studentData;
            if (!student) {
                const { data, error } = await supabase.from('students').select('*, classes(name)').eq('id', studentId).single();
                if (error) {
                    alert("Error fetching student details: " + error.message);
                    return;
                }
                student = data;
            }
            
            let totalPaid = feeMap ? feeMap[student.id] || 0 : 0;
            if (!feeMap) {
                const { data: fees } = await supabase.from('fees').select('amount').eq('student_id', studentId);
                if (fees) {
                    totalPaid = fees.reduce((sum, fee) => sum + fee.amount, 0);
                }
            }

            const total = parseFloat(student.totalFee) || 0;
            const pending = Math.max(total - totalPaid, 0);
            const className = student.classes ? student.classes.name : 'N/A';
            const days = Array.isArray(student.day) ? student.day.join(', ') : 'N/A';

            modalStudentName.textContent = student.name;
            modalDetails.innerHTML = `
                <p><strong>Phone:</strong> ${student.phone}</p>
                <p><strong>Class:</strong> ${className}</p>
                <p><strong>Assigned Days:</strong> ${days}</p>
                <p><strong>Total Fee:</strong> ${total}</p>
                <p><strong>Paid:</strong> ${totalPaid}</p>
                <p><strong>Balance:</strong> ${Math.round(pending)}</p>
            `;
            
            studentDetailsModal.style.display = "flex";
        }

        function openEditMode() {
            closeModal();
            const studentId = currentStudentId;
            const editFormModal = document.getElementById("editFormModal");
            
            supabase.from('students').select('*').eq('id', studentId).single().then(({ data: student, error }) => {
                if (error) {
                    alert("Error fetching student data: " + error.message);
                    return;
                }

                document.getElementById("editName").value = student.name || "";
                document.getElementById("editPhone").value = student.phone || "";
                document.getElementById("editTotalFee").value = student.totalFee || "";
                document.getElementById("editInitialPayment").value = student.initialPayment || "";

                document.querySelectorAll("#editDaysCheckboxes input").forEach(cb => cb.checked = false);
                const days = Array.isArray(student.day) ? student.day : [student.day];
                days.forEach(day => {
                    const cb = document.querySelector(`#editDaysCheckboxes input[value="${day}"]`);
                    if (cb) cb.checked = true;
                });
            });
            
            editFormModal.style.display = "flex";
        }

        function closeModal() {
            document.getElementById("studentDetailsModal").style.display = "none";
        }
        
        function closeEditFormModal() {
            document.getElementById("editFormModal").style.display = "none";
        }

        async function saveEdit() {
            const name = document.getElementById("editName").value;
            const phone = document.getElementById("editPhone").value;
            const totalFee = parseFloat(document.getElementById("editTotalFee").value) || 0;
            const initialPayment = parseFloat(document.getElementById("editInitialPayment").value) || 0;
            const balanceFee = totalFee - initialPayment;

            const selectedDays = [];
            document.querySelectorAll("#editDaysCheckboxes input:checked").forEach(cb => {
                selectedDays.push(cb.value);
            });

            const updatedStudent = {
                name: name,
                phone: phone,
                totalFee: totalFee,
                initialPayment: initialPayment,
                balanceFee: Math.round(balanceFee),
                day: selectedDays
            };

            const { error } = await supabase.from('students').update(updatedStudent).eq('id', currentStudentId);

            if (error) {
                alert("Error saving changes: " + error.message);
            } else {
                alert("Student updated successfully!");
                closeEditFormModal();
                renderStudents(document.getElementById('searchInput').value, selectedClassId);
            }
        }

        async function deleteStudent() {
            if (!confirm("Are you sure you want to delete this student?")) {
                return;
            }

            await supabase.from('fees').delete().eq('student_id', currentStudentId);
            await supabase.from('attendance').delete().eq('student_id', currentStudentId);

            const { error } = await supabase.from('students').delete().eq('id', currentStudentId);
            if (error) {
                alert("Error deleting student: " + error.message);
            } else {
                alert("Student deleted successfully!");
                closeModal();
                renderStudents(document.getElementById('searchInput').value, selectedClassId);
            }
        }
        
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                renderStudents(e.target.value, selectedClassId);
            }, 300); // Debounce for 300ms
        });

        renderClassFilters();
        renderStudents();
    </script>
</body>
</html>