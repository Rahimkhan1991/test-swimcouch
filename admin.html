<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - SwimCoach</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    h2 { color: #333; }
    button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    input[type="text"] { width: 100%; padding: 8px; margin-top: 10px; }
    #urlSection, #changeUrlBtn { margin-top: 15px; }
    #log { margin-top: 10px; font-size: 14px; color: green; }
  </style>
</head>
<body>
  <h2>Admin Panel</h2>

  <div id="urlSection">
    <label for="backupUrl">Enter Google Script Backup URL:</label>
    <input type="text" id="backupUrl" placeholder="https://script.google.com/macros/s/.../exec" />
    <button onclick="saveBackupUrl()">Save URL</button>
  </div>

  <button id="changeUrlBtn" onclick="changeBackupUrl()" style="display:none;">‚úèÔ∏è Change Backup URL</button>
  <button onclick="backupNow()">üîÅ Backup Now</button>

  <div id="log"></div>

  <script>
    const BACKUP_INTERVAL_MINUTES = 60; // üîÅ Auto backup every 60 mins

    // Load backup URL from localStorage
    const storedUrl = localStorage.getItem("backup_url");
    const backupUrlInput = document.getElementById("backupUrl");
    const urlSection = document.getElementById("urlSection");
    const changeUrlBtn = document.getElementById("changeUrlBtn");

    if (storedUrl) {
      urlSection.style.display = "none";
      changeUrlBtn.style.display = "inline-block";
    }

    function saveBackupUrl() {
      const url = backupUrlInput.value.trim();
      if (!url.startsWith("https://script.google.com")) {
        log("‚ùå Invalid URL. Must start with script.google.com", true);
        return;
      }
      localStorage.setItem("backup_url", url);
      urlSection.style.display = "none";
      changeUrlBtn.style.display = "inline-block";
      log("‚úÖ Backup URL saved.");
    }

    function changeBackupUrl() {
      urlSection.style.display = "block";
      backupUrlInput.value = localStorage.getItem("backup_url") || "";
    }

    function backupNow() {
      const backupUrl = localStorage.getItem("backup_url");
      if (!backupUrl) {
        log("‚ùå No backup URL set. Please enter it first.", true);
        return;
      }

      const backupData = {
        students: localStorage.getItem("students") || "{}",
        attendance: localStorage.getItem("attendance") || "{}",
        fees: localStorage.getItem("fees") || "{}"
      };

      fetch(backupUrl, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "data=" + encodeURIComponent(JSON.stringify(backupData))
      })
      .then(res => res.json())
      .then(res => {
        if (res.status === "success") {
          log("‚úÖ Backup successful.");
        } else {
          log("‚ùå Backup failed: " + res.message, true);
        }
      })
      .catch(err => log("‚ùå Backup error: " + err.message, true));
    }

    function log(message, isError = false) {
      const logDiv = document.getElementById("log");
      logDiv.style.color = isError ? "red" : "green";
      logDiv.textContent = message;
    }

    // First run backup immediately if URL is saved
    if (storedUrl) backupNow();

    // üîÅ Then auto-backup every X minutes
    setInterval(() => {
      if (localStorage.getItem("backup_url")) backupNow();
    }, BACKUP_INTERVAL_MINUTES * 60 * 1000);
  </script>
</body>
</html>
