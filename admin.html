<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‚öôÔ∏è Admin Panel - Coaching Classes</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #34c759;
      --accent: #2563eb;
      --bg: #f0f4f8;
      --card: #ffffffdd;
      --shadow: 0 6px 16px rgba(0,0,0,0.08);
    }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg);
      color: #1f2937;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 750px;
    }
    .company-header-box {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 14px;
      padding: 20px;
      text-align: center;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      color: #fff;
    }
    #companyNameDisplay {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0;
    }
    /* Accordion */
    .accordion {
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 18px;
      box-shadow: var(--shadow);
      background: var(--card);
    }
    .accordion-header {
      background: #f9fafb;
      padding: 16px 18px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 1.05rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .accordion-header:hover { background: #f3f4f6; }
    .accordion-content { display: none; padding: 20px; }
    .accordion.active .accordion-content { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

    /* Inputs */
    label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; }
    input[type="text"], input[type="password"], input[type="number"] {
      width: 100%; padding: 12px; margin-bottom: 14px;
      border-radius: 10px; border: 1px solid #d1d5db;
      background: #fff; font-size: 0.95rem;
    }

    /* Buttons */
    button {
      width: 100%; padding: 12px 16px; font-size: 1rem; font-weight: 600;
      border: none; border-radius: 10px; cursor: pointer;
      background: linear-gradient(135deg, var(--primary), #2ecc71);
      color: #fff; margin-top: 10px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
    .list-item {
      display: flex; justify-content: space-between; align-items: center;
      background: #f9fafb; padding: 12px; border-radius: 10px;
      margin-bottom: 10px; font-size: 0.95rem;
    }
    .list-item button { width: auto; padding: 6px 10px; margin-left: 6px; }
    .list-item .edit-btn { background: #2563eb; }
    .list-item .edit-btn:hover { background: #1e40af; }
    .list-item .delete-btn { background: #ef4444; }
    .list-item .delete-btn:hover { background: #dc2626; }

    .user-card { background: #f9fafb; border-radius: 10px; padding: 14px; margin-bottom: 14px; }

    .back-button { margin-top: 25px; background: linear-gradient(135deg, var(--accent), #1e40af); }

    @media (max-width: 600px) {
      .container { max-width: 100%; }
      #companyNameDisplay { font-size: 6vw; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="company-header-box">
      <h1 id="companyNameDisplay">Admin Panel</h1>
    </div>

    <!-- Accordion Sections -->
    <div class="accordion">
      <div class="accordion-header">üé® Customize Home Page <i class="fa fa-chevron-down"></i></div>
      <div class="accordion-content">
        <label for="companyNameInput">Display Name:</label>
        <input type="text" id="companyNameInput" placeholder="e.g., Aquaman Swim Club">
        <label for="logoUrlInput">Logo URL:</label>
        <input type="text" id="logoUrlInput" placeholder="e.g., https://example.com/logo.png">
        <button id="saveCustomizationBtn">Save Changes</button>
      </div>
    </div>

    <div class="accordion">
      <div class="accordion-header">üéì Manage Classes <i class="fa fa-chevron-down"></i></div>
      <div class="accordion-content">
        <label for="classNameInput">New Class Name:</label>
        <input type="text" id="classNameInput" placeholder="e.g., Grade 10 Math">
        <button id="createClassBtn"><i class="fa fa-plus"></i> Create Class</button>
        <div id="classList"></div>
      </div>
    </div>

    <div class="accordion">
      <div class="accordion-header">‚≠ê Manage Performance Metrics <i class="fa fa-chevron-down"></i></div>
      <div class="accordion-content">
        <label for="metricNameInput">New Metric Name:</label>
        <input type="text" id="metricNameInput" placeholder="e.g., Technique Score">
        <button id="createMetricBtn"><i class="fa fa-plus"></i> Create Metric</button>
        <div id="metricList"></div>
      </div>
    </div>

    <div class="accordion">
      <div class="accordion-header">üìÖ Session Settings <i class="fa fa-chevron-down"></i></div>
      <div class="accordion-content">
        <label><input type="checkbox" id="sessionEnabled"> Enable Session Tracking</label>
        <label for="sessionLength">Session Length (days):</label>
        <input type="number" id="sessionLength" min="1" placeholder="e.g., 4">
        <button id="saveSessionSettingsBtn"><i class="fa fa-save"></i> Save Settings</button>
      </div>
    </div>

    <div class="accordion">
      <div class="accordion-header">üë• User Management <i class="fa fa-chevron-down"></i></div>
      <div class="accordion-content">
        <div id="userList"></div>
      </div>
    </div>

    <!-- Back -->
    <button onclick="history.back()" class="back-button">‚¨ÖÔ∏è Back</button>
  </div>

  <script>
    // Accordion toggle
    document.querySelectorAll(".accordion-header").forEach(header=>{
      header.addEventListener("click",()=>{
        const acc = header.parentElement;
        acc.classList.toggle("active");
        const icon = header.querySelector("i");
        if(acc.classList.contains("active")) icon.classList.replace("fa-chevron-down","fa-chevron-up");
        else icon.classList.replace("fa-chevron-up","fa-chevron-down");
      });
    });

    // ========================
    // Supabase Logic
    // ========================
    const SUPABASE_URL = "https://ndishfwnkzdedfcywcle.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentCompanyId = null;

    async function checkUserSession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) window.location.href = "index.html";
    }

    async function loadDynamicHeader() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;
      const user = session.user;
      const { data, error } = await supabase
        .from("users")
        .select("company_id")
        .eq("id", user.id)
        .single();
      if (!error && data) currentCompanyId = data.company_id;
    }

    // üîπ Customization
    async function loadCustomization() {
      if (!currentCompanyId) return;
      const { data } = await supabase.from("companies").select("display_name, logo_url").eq("id", currentCompanyId).single();
      document.getElementById("companyNameInput").value = data?.display_name || "";
      document.getElementById("logoUrlInput").value = data?.logo_url || "";
      document.getElementById("companyNameDisplay").textContent = data?.display_name || "Admin Panel";
    }
    async function saveCustomization() {
      const companyName = document.getElementById("companyNameInput").value.trim();
      const logoUrl = document.getElementById("logoUrlInput").value.trim();
      await supabase.from("companies").update({ display_name: companyName, logo_url: logoUrl }).eq("id", currentCompanyId);
      alert("Customization saved!"); loadCustomization();
    }

    // üîπ Classes
    async function renderClasses() {
      if (!currentCompanyId) return;
      const { data } = await supabase.from("classes").select("id, name").eq("company_id", currentCompanyId);
      const classList = document.getElementById("classList"); classList.innerHTML = "";
      data?.forEach(cls=>{
        const item=document.createElement("div"); item.className="list-item";
        item.innerHTML=`
          <span>${cls.name}</span>
          <div>
            <button class="edit-btn" onclick="editClass('${cls.id}', '${cls.name}')">Edit</button>
            <button class="delete-btn" onclick="deleteClass('${cls.id}')">Delete</button>
          </div>`;
        classList.appendChild(item);
      });
    }
    async function createClass() {
      const name=document.getElementById("classNameInput").value.trim();
      if(!name) return alert("Enter class name");
      await supabase.from("classes").insert([{ name, company_id: currentCompanyId }]);
      document.getElementById("classNameInput").value=""; renderClasses();
    }
    async function editClass(id, oldName) {
      const newName=prompt("Edit class name:", oldName); if(!newName) return;
      await supabase.from("classes").update({ name:newName }).eq("id", id); renderClasses();
    }
    async function deleteClass(id) {
      if(confirm("Delete this class?")) { await supabase.from("classes").delete().eq("id", id); renderClasses(); }
    }

    // üîπ Metrics
    async function renderMetrics() {
      if (!currentCompanyId) return;
      const { data } = await supabase.from("performance_metrics").select("id, name").eq("company_id", currentCompanyId);
      const list=document.getElementById("metricList"); list.innerHTML="";
      data?.forEach(m=>{
        const item=document.createElement("div"); item.className="list-item";
        item.innerHTML=`
          <span>${m.name}</span>
          <div>
            <button class="edit-btn" onclick="editMetric('${m.id}', '${m.name}')">Edit</button>
            <button class="delete-btn" onclick="deleteMetric('${m.id}')">Delete</button>
          </div>`;
        list.appendChild(item);
      });
    }
    async function createMetric() {
      const name=document.getElementById("metricNameInput").value.trim(); if(!name) return;
      await supabase.from("performance_metrics").insert([{ name, company_id: currentCompanyId }]);
      document.getElementById("metricNameInput").value=""; renderMetrics();
    }
    async function editMetric(id, oldName) {
      const newName=prompt("Edit metric name:", oldName); if(!newName) return;
      await supabase.from("performance_metrics").update({ name:newName }).eq("id", id); renderMetrics();
    }
    async function deleteMetric(id) {
      if(confirm("Delete this metric?")) { await supabase.from("performance_metrics").delete().eq("id", id); renderMetrics(); }
    }

    // üîπ Sessions
    async function loadSessionSettings() {
      if (!currentCompanyId) return;
      const { data } = await supabase.from("companies").select("session_enabled, session_length_days").eq("id", currentCompanyId).single();
      document.getElementById("sessionEnabled").checked=data?.session_enabled||false;
      document.getElementById("sessionLength").value=data?.session_length_days||4;
    }
    async function saveSessionSettings() {
      const enabled=document.getElementById("sessionEnabled").checked;
      const length=parseInt(document.getElementById("sessionLength").value,10);
      await supabase.from("companies").update({ session_enabled:enabled, session_length_days:length }).eq("id", currentCompanyId);
      alert("Session settings updated!");
    }

    // üîπ Users
    async function loadUsers() {
      if (!currentCompanyId) return;
      const { data } = await supabase.from("users").select("id, email, role").eq("company_id", currentCompanyId);
      const userList=document.getElementById("userList"); userList.innerHTML="";
      data?.forEach(u=>{
        const card=document.createElement("div"); card.className="user-card";
        card.innerHTML=`
          <div><strong>Role:</strong> ${u.role}</div>
          <label>Email:</label>
          <input type="text" id="email-${u.id}" value="${u.email}">
          <label>Change Password:</label>
          <input type="password" id="password-${u.id}" placeholder="New Password">
          <button onclick="updateUser('${u.id}')">Update User</button>`;
        userList.appendChild(card);
      });
    }
    async function updateUser(userId) {
      const newEmail=document.getElementById(`email-${userId}`).value;
      const newPassword=document.getElementById(`password-${userId}`).value;
      alert("‚ö†Ô∏è Updating email/password requires backend with service role. Values captured in console.");
      console.log("Requested update:", { userId, newEmail, newPassword });
    }

    // üîπ Event listeners
    document.getElementById("saveCustomizationBtn").addEventListener("click", saveCustomization);
    document.getElementById("createClassBtn").addEventListener("click", createClass);
    document.getElementById("createMetricBtn").addEventListener("click", createMetric);
    document.getElementById("saveSessionSettingsBtn").addEventListener("click", saveSessionSettings);

    // Init
    window.onload = async () => {
      await checkUserSession();
      await loadDynamicHeader();
      await loadCustomization();
      await renderClasses();
      await renderMetrics();
      await loadUsers();
      await loadSessionSettings();
    };
  </script>
</body>
</html>
