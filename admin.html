<!DOCTYPE html>
<html lang="en">
<head>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Panel - Swim Coach</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body {
font-family: 'Segoe UI', sans-serif;
margin: 0;
padding: 0;
background: linear-gradient(to right, #e0f7fa, #f0f4f8);
}
/* New style for the dynamic header */
.dynamic-header {
    text-align: center;
    padding: 20px;
    margin-bottom: 20px;
}
.dynamic-header h1 {
    display: inline-block;
    vertical-align: middle;
    color: #007bff;
    margin: 0;
}
.dynamic-header img {
    height: 50px;
    margin-right: 15px;
    vertical-align: middle;
    display: none;
}
.container {
max-width: 800px;
margin: 0 auto;
padding: 20px;
}
.section {
background: white;
border-radius: 12px;
padding: 25px 20px;
margin-bottom: 30px;
box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
text-align: center;
}
.section h2 {
margin-bottom: 20px;
color: #333;
}
button {
background: #007bff;
color: white;
border: none;
padding: 14px 20px;
border-radius: 10px;
font-size: 16px;
margin: 10px 0;
width: 100%;
cursor: pointer;
transition: background 0.3s;
}
button:hover {
background: #0056b3;
}
input[type="text"] {
width: 95%;
padding: 12px;
margin: 15px 0;
border: 1px solid #ccc;
border-radius: 8px;
font-size: 16px;
}
#driveScriptSection {
margin-top: 20px;
}
#driveBackupStatus {
margin-top: 10px;
font-size: 14px;
color: green;
}
#restoreFileInput {
display: none;
}
@media (max-width: 500px) {
.section {
padding: 20px 15px;
}
button {
font-size: 15px;
}
}
.user-list {
    text-align: left;
}
.user-card {
    border: 1px solid #ccc;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    background: #f9f9f9;
}
.user-card label {
    font-weight: bold;
    display: block;
    margin-top: 10px;
}
</style>
</head>
<body>
<header class="dynamic-header">
    <img id="headerLogo" src="" alt="Company Logo">
    <h1 id="headerTitle">Admin Panel</h1>
</header>
<div class="container">
<div class="section">
    <h2>üé® Customize Home Page</h2>
    <label for="companyNameInput">Company Name:</label>
    <input type="text" id="companyNameInput" placeholder="e.g., Aquaman Swim Club">
    <label for="logoUrlInput">Logo URL:</label>
    <input type="text" id="logoUrlInput" placeholder="e.g., https://example.com/logo.png">
    <button id="saveCustomizationBtn">Save Changes</button>
</div>

<div class="section">
    <h2>
        <span class="material-icons" style="vertical-align: middle; margin-right: 6px;">group</span>
        User Management
    </h2>
    <div id="userList" class="user-list">
        </div>
</div>

</div>
<div class="footer-buttons">
<button class="btn-back" onclick="history.back()"
style="width: 95%; ; margin: 15px auto; font-weight: bold; display: block;">
‚¨ÖÔ∏è Back
</button>
</div>
<script>
// Supabase client initialization
const SUPABASE_URL = 'https://ndishfwnkzdedfcywcle.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentCompanyId = null;

// Function to load and display dynamic header content
async function loadDynamicHeader() {
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    if (sessionError || !session) {
        window.location.href = 'index.html';
        return;
    }

    const user = session.user;
    const { data, error } = await supabase
        .from('users')
        .select('company_id, companies(display_name, logo_url)')
        .eq('id', user.id)
        .single();

    const headerTitle = document.getElementById('headerTitle');
    const headerLogo = document.getElementById('headerLogo');

    if (error || !data || !data.companies) {
        console.error('Error fetching company data:', error?.message);
        return;
    }
    
    currentCompanyId = data.company_id; // Store company ID for later use

    headerTitle.textContent = data.companies.display_name || 'Admin Panel';
    if (data.companies.logo_url) {
        headerLogo.src = data.companies.logo_url;
        headerLogo.style.display = 'inline-block';
    }

    // Set input fields to current values
    document.getElementById('companyNameInput').value = data.companies.display_name || '';
    document.getElementById('logoUrlInput').value = data.companies.logo_url || '';
}

// Function to save customization data
document.getElementById('saveCustomizationBtn').addEventListener('click', async () => {
    if (!currentCompanyId) {
        alert('Could not determine company ID. Please reload the page.');
        return;
    }

    const companyName = document.getElementById('companyNameInput').value;
    const logoUrl = document.getElementById('logoUrlInput').value;

    const { error } = await supabase
        .from('companies')
        .update({ display_name: companyName, logo_url: logoUrl })
        .eq('id', currentCompanyId); // Correctly update using the company ID

    if (error) {
        console.error('Error saving customization:', error);
        alert('Failed to save changes.');
    } else {
        alert('Changes saved successfully!');
        loadDynamicHeader();
    }
});

// Function to load all users and display them
async function loadUsers() {
    if (!currentCompanyId) {
        console.error('Company ID not available.');
        return;
    }

    const { data: users, error } = await supabase
        .from('users')
        .select('id, email, role')
        .eq('company_id', currentCompanyId);

    if (error) {
        console.error('Error fetching users:', error);
        return;
    }

    const userList = document.getElementById('userList');
    userList.innerHTML = ''; // Clear previous list

    users.forEach(user => {
        const userCard = document.createElement('div');
        userCard.className = 'user-card';
        userCard.innerHTML = `
            <div><strong>Role:</strong> ${user.role}</div>
            <label for="email-${user.id}">Email:</label>
            <input type="text" id="email-${user.id}" value="${user.email}" />
            <label for="password-${user.id}">Change Password (leave blank if no change):</label>
            <input type="text" id="password-${user.id}" placeholder="New Password" />
            <button onclick="updateUser('${user.id}')">Update User</button>
        `;
        userList.appendChild(userCard);
    });
}

// Function to update a user's email or password
async function updateUser(userId) {
    const newEmail = document.getElementById(`email-${userId}`).value;
    const newPassword = document.getElementById(`password-${userId}`).value;

    if (newPassword) {
        // Update both email and password if a new password is provided
        const { error } = await supabase.auth.admin.updateUserById(
            userId, { email: newEmail, password: newPassword }
        );
        if (error) {
            console.error('Update failed:', error);
            alert('Failed to update user. Check permissions.');
            return;
        }
    } else {
        // Only update the email
        const { error } = await supabase.auth.admin.updateUserById(
            userId, { email: newEmail }
        );
        if (error) {
            console.error('Update failed:', error);
            alert('Failed to update user. Check permissions.');
            return;
        }
    }

    alert('User updated successfully!');
    // Reload the user list to show changes
    loadUsers();
}

// Initial session check
async function checkUserSession() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
        window.location.href = 'index.html';
    }
}

// Wait for dynamic header to load before loading users
window.onload = async () => {
    await checkUserSession();
    await loadDynamicHeader();
    await loadUsers();
};
</script>
</body>
</html>