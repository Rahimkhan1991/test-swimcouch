<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Student Attendance Report</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0; padding: 20px; font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #e0f7fa, #fce4ec); color: #2c3e50;
  }
  .container {
    max-width: 900px; margin: auto; background: rgba(255, 255, 255, 0.9);
    border-radius: 16px; padding: 30px 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
  }
  h1 { text-align: center; color: #1e88e5; margin-bottom: 20px; font-weight: 700; font-size: 28px; }
  .filters { display: grid; gap: 14px; grid-template-columns: 1fr; margin-bottom: 10px; }
  label { font-weight: 600; color: #374151; }
  select, input[type="date"] {
    width: 100%; padding: 12px; font-size: 1em; border: 1px solid #ccc; border-radius: 8px;
    background-color: #fff;
  }
  .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .footer-buttons {
    display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin: 12px 0 18px;
  }
  .footer-buttons button, .btn-back, .btn-clear {
    padding: 12px 18px; font-size: 1em; border: none; border-radius: 8px; cursor: pointer;
    background-color: #3b82f6; color: white; transition: background 0.2s;
  }
  .btn-clear { background: #f59e0b; }
  .footer-buttons button:hover, .btn-back:hover { background-color: #2563eb; }
  .btn-clear:hover { background: #d97706; }
  .report {
    margin-top: 18px; padding: 22px; border-radius: 14px; background: #f9fafb;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
  }
  .report-title { display:flex; justify-content:space-between; align-items:center;
    margin-bottom: 10px; font-size: 18px; font-weight: 600; color: #374151; }
  .subtle { color:#64748b; font-weight:500; font-size: 0.95rem; }
  .summary-grid {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 10px;
  }
  .kpi {
    background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:12px;
  }
  .kpi .value { font-size:1.2rem; font-weight:700; color:#111827; }
  .kpi .label { font-size:0.85rem; color:#6b7280; }
  .report-table {
    width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 16px;
    border-radius: 10px; overflow: hidden;
  }
  .report-table th, .report-table td {
    padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: left; font-size: 0.95em;
  }
  .report-table th { background-color: #e0f2fe; color: #1e3a8a; }
  .report-table tr:nth-child(even) { background-color: #f1f5f9; }
  .status {
    position: fixed; left: 50%; transform: translateX(-50%); bottom: 18px;
    min-width: 260px; padding: 10px 14px; border-radius: 8px;
    background: #d4edda; color: #155724; box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    z-index: 50;
  }
  .status.error { background: #fdecea; color: #611a15; }
  .muted { color:#6b7280; }
  .divider { height:1px; background:#e5e7eb; margin:12px 0; }
  .helper { font-size: 0.85rem; color:#6b7280; margin-top: 4px; }
  .hidden { display: none; }
  .inline {
    display:flex; gap:8px; align-items:center; flex-wrap: wrap; color:#475569; font-size:0.95rem;
  }
  .badge { background:#e5e7eb; border-radius:12px; padding:2px 8px; font-size:0.8rem; }
  .meta { display:flex; flex-direction:column; gap:4px; }
  .meta .line { display:flex; gap:8px; flex-wrap:wrap; }
  .meta strong { color:#111827; }
  .btn-back {
    display: block; margin: 18px auto 0; background-color: #64748b; width: 95%;
  }

  @media (max-width: 700px) {
    .row-2 { grid-template-columns: 1fr; }
    .summary-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="container">
  <h1>üìÑ Student Attendance Report</h1>

  <div class="filters">
    <div>
      <label for="classSelect">Select Class</label>
      <select id="classSelect">
        <option value="">-- All Classes --</option>
      </select>
    </div>

    <div>
      <label for="studentSelect">Select Student</label>
      <select id="studentSelect"></select>
      <div class="helper">Students are filtered by class & company.</div>
    </div>

    <div class="row-2">
      <div>
        <label for="rangeSelect">Date Range</label>
        <select id="rangeSelect">
          <option value="all">All Time</option>
          <option value="thisMonth">This Month</option>
          <option value="lastMonth">Last Month</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>

      <div class="row-2 hidden" id="customRange">
        <div>
          <label for="startDate">Start Date</label>
          <input type="date" id="startDate"/>
        </div>
        <div>
          <label for="endDate">End Date</label>
          <input type="date" id="endDate"/>
        </div>
      </div>
    </div>
  </div>

  <div class="footer-buttons">
    <button onclick="generateReport()">Generate Report</button>
    <button onclick="downloadPDF()">Download PDF</button>
    <button onclick="sendWhatsApp()">Send via WhatsApp</button>
    <button class="btn-clear" onclick="resetForm()">Clear</button>
  </div>

  <div id="reportOutput"></div>
</div>

<button class="btn-back" onclick="history.back()">
  ‚¨ÖÔ∏è Back
</button>

<script>
  // ======= Supabase Config =======
  const SUPABASE_URL = 'https://ndishfwnkzdedfcywcle.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentCompanyId = null;
  let currentStudent = null;
  let currentReport = null;

  function toast(msg, type='success') {
    const el = document.createElement('div');
    el.className = `status ${type==='error' ? 'error' : ''}`;
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2600);
  }

  function resetForm() {
    document.getElementById('classSelect').value = '';
    document.getElementById('studentSelect').innerHTML = '<option value="">-- Select Student --</option>';
    document.getElementById('rangeSelect').value = 'all';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('customRange').classList.add('hidden');
    document.getElementById('reportOutput').innerHTML = '';
    currentStudent = null;
    currentReport = null;
    toast('Form cleared');
  }

  async function ensureSessionAndCompany() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.href = 'index.html';
      return false;
    }
    const { data, error } = await supabase.from('users')
      .select('company_id')
      .eq('id', session.user.id)
      .single();
    if (error || !data?.company_id) {
      toast('Could not resolve company. Contact admin.', 'error');
      return false;
    }
    currentCompanyId = data.company_id;
    return true;
  }

  async function populateClassList() {
    const select = document.getElementById("classSelect");
    const { data: classes, error } = await supabase
      .from('classes')
      .select('id, name')
      .eq('company_id', currentCompanyId)
      .order('name');
    if (error) {
      console.error('Error fetching classes:', error.message);
      toast('Failed to load classes', 'error');
      return;
    }
    classes.forEach(c => {
      const option = document.createElement("option");
      option.value = c.id;
      option.text = c.name;
      select.appendChild(option);
    });
  }

  async function populateStudentList(classId=null) {
    const select = document.getElementById("studentSelect");
    select.innerHTML = '<option value="">-- Select Student --</option>';

    let query = supabase.from('students')
      .select('id, name, phone, day, class_id, classes(name)')
      .eq('company_id', currentCompanyId)
      .order('name');

    if (classId) query = query.eq('class_id', classId);

    const { data: students, error } = await query;
    if (error) {
      console.error('Error fetching students:', error.message);
      toast('Failed to load students', 'error');
      return;
    }

    students.forEach(s => {
      const option = document.createElement("option");
      option.value = s.id;
      option.text = s.name + (s.classes?.name ? ` ‚Äî ${s.classes.name}` : '');
      option.dataset.phone = s.phone || '';
      option.dataset.day = JSON.stringify(s.day || []);
      option.dataset.className = s.classes?.name || '';
      select.appendChild(option);
    });
  }

  document.getElementById('classSelect').addEventListener('change', (e) => {
    const classId = e.target.value || null;
    populateStudentList(classId);
    document.getElementById("studentSelect").value = '';
  });

  // init
  (async function init() {
    const ok = await ensureSessionAndCompany();
    if (!ok) return;
    await populateClassList();
    await populateStudentList();
    toast('Ready');
  })();

  // === other functions (generateReport, downloadPDF, sendWhatsApp, etc.) remain same ===
</script>
</body>
</html>
