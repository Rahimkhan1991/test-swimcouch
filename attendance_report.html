<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Attendance Report</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 20px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-top: 20px;
      border-radius: 10px;
    }
    h2, h3 {
      text-align: center;
    }
    select, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .session-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .session-table th, .session-table td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    .session-table tr:nth-child(even) {
      background-color: #f1f1f1;
    }
    .btn {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .btn:hover {
      background: #0056b3;
    }
    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Student Attendance Report</h2>
    <select id="studentSelect"></select>
    <div class="actions">
      <button class="btn" onclick="generateStudentReport()">Generate Report</button>
      <button class="btn" onclick="printReport()">Print / Export PDF</button>
      <button class="btn" onclick="sendWhatsApp()">Send via WhatsApp</button>
    </div>
    <div id="reportArea"></div>
  </div>

  <script>
    let currentReportStudent = null;
    let currentReportData = [];

    function populateStudentDropdown() {
      const students = JSON.parse(localStorage.getItem("students") || "[]");
      const dropdown = document.getElementById("studentSelect");
      dropdown.innerHTML = '<option value="">Select Student</option>';
      students.forEach((student) => {
        const option = document.createElement("option");
        option.value = student.id;
        option.textContent = student.name;
        dropdown.appendChild(option);
      });
    }

    function generateStudentReport() {
      const selectedId = document.getElementById("studentSelect").value;
      if (!selectedId) return alert("Please select a student");

      const students = JSON.parse(localStorage.getItem("students") || "[]");
      const attendance = JSON.parse(localStorage.getItem("attendance") || "[]");
      const student = students.find((s) => s.id == selectedId);
      const records = attendance
        .filter((a) => a.studentId == selectedId && a.status === "Present")
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      currentReportStudent = student;
      currentReportData = records;

      const sessions = [];
      for (let i = 0; i < records.length; i += 4) {
        sessions.push(records.slice(i, i + 4));
      }

      let html = `
        <h3>${student.name}</h3>
        <p><strong>Phone:</strong> ${student.phone}</p>
        <p><strong>Total Presents:</strong> ${records.length}</p>
        <p><strong>Total Sessions:</strong> ${sessions.length}</p>
        <h3>Session Breakdown</h3>
        <table class="session-table">
          <thead>
            <tr><th>Session #</th><th>Dates</th></tr>
          </thead>
          <tbody>
      `;

      sessions.forEach((session, index) => {
        const dates = session.map((s) => s.date).join(", ");
        html += `<tr><td>${index + 1}</td><td>${dates}</td></tr>`;
      });

      html += `</tbody></table>`;
      document.getElementById("reportArea").innerHTML = html;
    }

    function printReport() {
      if (!currentReportStudent || currentReportData.length === 0) {
        alert("Please generate the report first.");
        return;
      }

      const content = document.querySelector("#reportArea").innerHTML;
      const win = window.open("", "_blank");
      win.document.write(`
        <html>
        <head><title>Attendance Report</title>
        <style>
          body { font-family: Arial; padding: 20px; }
          table { width: 100%; border-collapse: collapse; }
          th, td { padding: 10px; border: 1px solid #000; }
          tr:nth-child(even) { background: #eee; }
        </style>
        </head>
        <body>
        <h2>Attendance Report</h2>
        ${content}
        </body>
        </html>
      `);
      win.document.close();
      win.print();
    }

    function sendWhatsApp() {
      if (!currentReportStudent || currentReportData.length === 0) {
        alert("Please generate the report first.");
        return;
      }

      const name = currentReportStudent.name;
      const phone = currentReportStudent.phone.replace(/\D/g, "");
      const total = currentReportData.length;
      const sessions = Math.floor(total / 4);
      let message = `*Attendance Report*\nName: ${name}\nPhone: ${currentReportStudent.phone}\nTotal Presents: ${total}\nSessions Completed: ${sessions}`;

      const link = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
      window.open(link, "_blank");
    }

    window.onload = populateStudentDropdown;
  </script>
</body>
</html>
