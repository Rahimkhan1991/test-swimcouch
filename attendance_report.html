<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Attendance Report</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f2f2f2;
    }
    h2 {
      text-align: center;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
    }
    select, button {
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 15px;
      width: 100%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #007BFF;
      color: white;
    }
    .session-row {
      background-color: #e6f7ff;
    }
    .striped:nth-child(even) {
      background-color: #f9f9f9;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      background-color: #28a745;
      color: white;
      cursor: pointer;
    }
    .btn-print { background-color: #17a2b8; }
    .btn-back { background-color: #6c757d; }
    .btn-whatsapp { background-color: #25d366; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Student Attendance Report</h2>
    <label for="studentSelect">Select Student:</label>
    <select id="studentSelect"></select>

    <div class="button-group">
      <button class="btn" onclick="generateReport()">Generate Report</button>
      <button class="btn btn-print" onclick="window.print()">Print Report</button>
      <button class="btn btn-whatsapp" onclick="sendWhatsApp()">Send on WhatsApp</button>
      <button class="btn btn-back" onclick="window.history.back()">Back</button>
    </div>

    <div id="reportSection"></div>
  </div>

  <script>
    let currentReportStudent = null;

    function loadStudents() {
      const students = JSON.parse(localStorage.getItem('students')) || [];
      const studentSelect = document.getElementById('studentSelect');
      studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
      students.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = student.name;
        studentSelect.appendChild(option);
      });
    }

    function generateReport() {
  const studentId = document.getElementById('studentSelect').value;
  if (!studentId) return alert("Please select a student.");

  const students = JSON.parse(localStorage.getItem('students')) || [];
  const student = students.find(s => s.id.toString() === studentId.toString());
  if (!student) return alert("Student not found.");

  currentReportStudent = student;

  const attendance = JSON.parse(localStorage.getItem('attendance')) || [];
  const studentAttendance = attendance.filter(a => a.studentId.toString() === studentId.toString() && a.status === 'Present')
                                      .sort((a, b) => new Date(a.date) - new Date(b.date));

  let reportHTML = `<h3>${student.name}</h3>`;
  reportHTML += `<p>Phone: ${student.phone}</p>`;

  const sessionCount = Math.floor(studentAttendance.length / 4);
  const remaining = studentAttendance.length % 4;

  reportHTML += `<p><strong>Total Sessions:</strong> ${sessionCount}</p>`;
  reportHTML += `<p><strong>Remaining Days:</strong> ${remaining}</p>`;

  reportHTML += '<table><tr><th>Session</th><th>Date</th></tr>';

  studentAttendance.forEach((att, index) => {
    const sessionNumber = Math.floor(index / 4) + 1;
    const isNewSession = index % 4 === 0;
    reportHTML += `<tr class="${isNewSession ? 'session-row' : 'striped'}"><td>Session ${sessionNumber}</td><td>${att.date}</td></tr>`;
  });

  reportHTML += '</table>';

  document.getElementById('reportSection').innerHTML = reportHTML;
}

    function sendWhatsApp() {
      if (!currentReportStudent) return alert("Please generate the report first.");

      const attendance = JSON.parse(localStorage.getItem('attendance')) || [];
      const studentAttendance = attendance.filter(a => a.studentId == currentReportStudent.id && a.status === 'Present')
                                          .sort((a, b) => new Date(a.date) - new Date(b.date));

      const sessionCount = Math.floor(studentAttendance.length / 4);
      const remaining = studentAttendance.length % 4;

      let message = `*Attendance Report for ${currentReportStudent.name}*\n`;
      message += `Phone: ${currentReportStudent.phone}\n\n`;
      message += `Total Sessions: ${sessionCount}\nRemaining Days: ${remaining}\n\nDates:\n`;

      studentAttendance.forEach((att, index) => {
        const sessionNumber = Math.floor(index / 4) + 1;
        message += `Session ${sessionNumber}: ${att.date}\n`;
      });

      const whatsappURL = `https://wa.me/${currentReportStudent.phone.replace(/[^\d]/g, '')}?text=${encodeURIComponent(message)}`;
      window.open(whatsappURL, '_blank');
    }

    loadStudents();
  </script>
</body>
</html>
