<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üèÖ Student Report</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #34c759;
      --accent: #2563eb;
      --bg-gradient: linear-gradient(135deg, #f0fff4, #e6f7ff);
      --card-bg: rgba(255,255,255,0.9);
      --shadow: 0 6px 20px rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Inter', sans-serif;
      background: var(--bg-gradient);
      color: #1f2937;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: var(--card-bg);
      border-radius: 18px;
      padding: 25px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    h1 {
      text-align: center;
      color: var(--accent);
      margin-bottom: 25px;
      font-weight: 700;
      font-size: 28px;
    }
    /* Filters */
    .filter-panel {
      background: #ffffffd9;
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 15px;
    }
    label {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 5px;
      display: block;
      color: #374151;
    }
    select, input[type="date"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      background: #fff;
      color: #111827;
    }
    /* Buttons */
    .footer-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin: 10px 0 20px;
    }
    .btn, .btn-back {
      flex: 1;
      padding: 12px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg, var(--primary), #2ecc71);
      transition: transform 0.2s ease;
    }
    .btn:hover, .btn-back:hover {
      transform: translateY(-2px);
    }
    .btn-back {
      background: linear-gradient(135deg, var(--accent), #1e40af);
      width: 100%;
      margin-top: 20px;
    }
    /* Report */
    .report {
      margin-top: 20px;
      padding: 25px;
      border-radius: 16px;
      background: #f9fafb;
      box-shadow: var(--shadow);
    }
    .report-title {
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #111827;
    }
    .summary-grid {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 25px 0;
    }
    .kpi {
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      flex: 1;
      min-width: 150px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    .kpi .value { font-size: 24px; font-weight: 700; color: var(--accent); }
    .kpi .label { font-size: 14px; color: #6b7280; }
    /* Table */
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      border-radius: 12px;
      overflow: hidden;
    }
    .report-table th, .report-table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.95rem;
      text-align: left;
    }
    .report-table th {
      background: #eff6ff;
      color: var(--accent);
      font-weight: 600;
    }
    .report-table tr:nth-child(even) { background: #f9fafb; }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      color: white;
    }
    .badge.present { background: var(--primary); }
    .badge.absent { background: #ef4444; }
    .stars { color: #facc15; font-size: 0.9rem; }
    @media (max-width: 650px) {
      .footer-buttons { flex-direction: column; }
      .btn { width: 100%; }
      .summary-grid { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Student Report</h1>

    <!-- Filter Panel -->
    <div class="filter-panel">
      <div>
        <label for="classSelect">Class</label>
        <select id="classSelect"></select>
      </div>
      <div>
        <label for="studentSelect">Student</label>
        <select id="studentSelect"></select>
      </div>
      <div>
        <label for="rangeSelect">Date Range</label>
        <select id="rangeSelect" onchange="toggleCustomRange()">
          <option value="all">All Time</option>
          <option value="thisMonth">This Month</option>
          <option value="lastMonth">Last Month</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div id="customRange" style="display:none;">
        <label>Start Date</label>
        <input type="date" id="startDate">
        <label>End Date</label>
        <input type="date" id="endDate">
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="footer-buttons">
      <button class="btn" onclick="generateReport()">Generate Report</button>
      <button class="btn" onclick="downloadPDF()">Download PDF</button>
      <button class="btn" onclick="sendWhatsApp()">Send WhatsApp</button>
    </div>

    <div id="reportOutput"></div>

    <!-- Back -->
    <button class="btn-back" onclick="history.back()">‚¨ÖÔ∏è Back</button>
  </div>

<script>
const SUPABASE_URL = "https://ndishfwnkzdedfcywcle.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentReport = null;
let sessionSettings = { enabled: false, length: 4 };

// üîπ Load admin session settings
async function loadSettings() {
  const { data, error } = await supabase.from("settings").select("session_enabled, session_length").single();
  if (!error && data) {
    sessionSettings.enabled = data.session_enabled;
    sessionSettings.length = data.session_length;
  }
}

// Toggle custom date inputs
function toggleCustomRange() {
  document.getElementById("customRange").style.display =
    document.getElementById("rangeSelect").value === "custom" ? "block" : "none";
}

// Populate dropdowns
async function populateClasses() {
  const { data, error } = await supabase.from("classes").select("id, name");
  const select = document.getElementById("classSelect");
  select.innerHTML = '<option value="">-- Select Class --</option>';
  if (!error && data) {
    data.forEach(cls => {
      const opt = document.createElement("option");
      opt.value = cls.id;
      opt.textContent = cls.name;
      select.appendChild(opt);
    });
  }
}
async function populateStudents(classId=null) {
  let query = supabase.from("students").select("id, name");
  if (classId) query = query.eq("class_id", classId);
  const { data, error } = await query;
  const select = document.getElementById("studentSelect");
  select.innerHTML = '<option value="">-- Select Student --</option>';
  if (!error && data) {
    data.forEach(stu => {
      const opt = document.createElement("option");
      opt.value = stu.id;
      opt.textContent = stu.name;
      select.appendChild(opt);
    });
  }
}

// Generate report
async function generateReport() {
  const studentId = document.getElementById("studentSelect").value;
  const reportDiv = document.getElementById("reportOutput");
  reportDiv.innerHTML = "";
  if (!studentId) return reportDiv.innerHTML = "<p>Please select a student.</p>";

  await loadSettings(); // ensure latest settings loaded

  // Fetch student info
  const { data: student } = await supabase.from("students")
    .select("id, name, phone, classes(name)").eq("id", studentId).single();
  currentReport = { student };

  // Fetch attendance
  let query = supabase.from("attendance").select("id,date,status").eq("student_id", studentId);
  const range = document.getElementById("rangeSelect").value;
  const today = new Date();
  let startDate, endDate;
  if (range === "thisMonth") {
    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
    endDate = new Date(today.getFullYear(), today.getMonth()+1, 0);
  } else if (range === "lastMonth") {
    startDate = new Date(today.getFullYear(), today.getMonth()-1, 1);
    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
  } else if (range === "custom") {
    startDate = new Date(document.getElementById("startDate").value);
    endDate = new Date(document.getElementById("endDate").value);
  }
  if (startDate && endDate) query = query.gte("date", startDate.toISOString()).lte("date", endDate.toISOString());
  const { data: attendance } = await query;
  if (!attendance || attendance.length===0) return reportDiv.innerHTML="<p>No records found.</p>";

  // Fetch performances
  const { data: performances } = await supabase.from("performance_records")
    .select("id,score,notes,attendance_id,performance_metrics(name)")
    .in("attendance_id", attendance.map(a=>a.id));

  const perfMap = {};
  performances?.forEach(p=>{
    if (!perfMap[p.attendance_id]) perfMap[p.attendance_id]=[];
    perfMap[p.attendance_id].push(p);
  });

  // Summaries
  const presentCount = attendance.filter(r=>r.status==="Present").length;
  let sessionsCompleted = 0, daysRemaining = 0;
  if (sessionSettings.enabled) {
    sessionsCompleted = Math.floor(presentCount/sessionSettings.length);
    daysRemaining = sessionSettings.length - (presentCount % sessionSettings.length);
    if (daysRemaining === sessionSettings.length) daysRemaining = 0;
  }

  // Performance summary
  const summaryMap = {};
  performances?.forEach(p=>{
    const metric = p.performance_metrics.name;
    if (!summaryMap[metric]) summaryMap[metric] = { total:0,count:0 };
    if (p.score!=null){ summaryMap[metric].total+=p.score; summaryMap[metric].count++; }
  });
  let perfSummaryHTML = "";
  if (Object.keys(summaryMap).length>0){
    perfSummaryHTML = `<h3>‚≠ê Performance Summary</h3><table class="report-table"><thead><tr><th>Metric</th><th>Average</th></tr></thead><tbody>`;
    for (const [metric,val] of Object.entries(summaryMap)){
      const avg = (val.total/val.count).toFixed(1);
      const stars = "‚òÖ".repeat(Math.round(avg));
      perfSummaryHTML += `<tr><td>${metric}</td><td><span class="stars">${stars}</span></td></tr>`;
    }
    perfSummaryHTML += "</tbody></table>";
  }

  // Attendance table
  const rows = attendance.map(att=>{
    let perfHtml = "";
    if (perfMap[att.id]){
      perfHtml = "<ul style='margin:5px 0 0 15px;'>";
      perfMap[att.id].forEach(p=>{
        perfHtml += `<li>${p.performance_metrics.name}: ${"‚òÖ".repeat(p.score||0)} ${p.notes?`(${p.notes})`:""}</li>`;
      });
      perfHtml += "</ul>";
    }
    return `<tr>
      <td>${new Date(att.date).toLocaleDateString()}</td>
      <td><span class="badge ${att.status==="Present"?"present":"absent"}">${att.status}</span></td>
      <td>${perfHtml||"‚Äî"}</td>
    </tr>`;
  }).join("");

  reportDiv.innerHTML = `
    <div class="report">
      <div class="report-title">üìã Report for ${student.name}</div>
      <p><strong>Class:</strong> ${student.classes?.name||"N/A"}</p>
      <p><strong>Phone:</strong> ${student.phone||"N/A"}</p>
      <div class="summary-grid">
        <div class="kpi"><div class="value">${presentCount}</div><div class="label">Total Presents</div></div>
        ${sessionSettings.enabled?`
        <div class="kpi"><div class="value">${sessionsCompleted}</div><div class="label">Sessions</div></div>
        <div class="kpi"><div class="value">${daysRemaining}</div><div class="label">Days to Next</div></div>`:""}
      </div>
      ${perfSummaryHTML}
      <h3 style="margin-top:20px;">üìÖ Attendance Details</h3>
      <table class="report-table"><thead><tr><th>Date</th><th>Status</th><th>Performance</th></tr></thead><tbody>${rows}</tbody></table>
    </div>`;
}

function downloadPDF(){
  const reportDiv=document.getElementById("reportOutput");
  if(!reportDiv.innerHTML.trim()) return alert("Generate the report first.");
  html2pdf().from(reportDiv).set({
    margin:0.5,filename:"StudentReport.pdf",
    html2canvas:{scale:2},
    jsPDF:{unit:"in",format:"letter",orientation:"portrait"}
  }).save();
}
function sendWhatsApp(){
  const student=currentReport?.student;
  if(!student||!student.phone) return alert("No phone number available.");
  const totalPresent=currentReport.attendance.filter(r=>r.status==="Present").length;
  const message=`Hello ${student.name}, your attendance & performance report is ready. ‚úÖ Total Presents: ${totalPresent}`;
  window.open(`https://wa.me/${student.phone.replace(/\D/g,'')}?text=${encodeURIComponent(message)}`,"_blank");
}

// Init
populateClasses();
populateStudents();
document.getElementById("classSelect").addEventListener("change",e=>populateStudents(e.target.value));
</script>
</body>
</html>
