<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Receipts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/+esm";

    const SUPABASE_URL = "https://ndishfwnkzdedfcywcle.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let selectedFee = null;

    async function loadClasses() {
      const { data: classes } = await supabase.from("classes").select("id,name").order("name");
      const classSelect = document.getElementById("classSelect");
      classes?.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        classSelect.appendChild(opt);
      });
    }

    async function loadStudents(classId, search="") {
  const studentSelect = document.getElementById("studentSelect");
  studentSelect.innerHTML = `<option value="">-- Select Student --</option>`;
  if (!classId) return;

  let query = supabase
    .from("students")
    .select("id,name,class_id")  // include the linking column for debugging
    .eq("class_id", classId)
    .order("name");

  if (search) {
    query = query.ilike("name", `%${search}%`);
  }

  const { data: students, error } = await query;

  if (error) {
    console.error("Error loading students:", error);
    return;
  }

  if (!students?.length) {
    const opt = document.createElement("option");
    opt.textContent = "No students found";
    studentSelect.appendChild(opt);
    return;
  }

  students.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = s.name;
    studentSelect.appendChild(opt);
  });
}


    async function loadPayments(studentId) {
      const tbody = document.querySelector("#paymentTable tbody");
      tbody.innerHTML = "";
      if (!studentId) {
        tbody.innerHTML = `<tr><td colspan="3">Select a student to view payments.</td></tr>`;
        return;
      }
      const { data: fees, error } = await supabase
        .from("fees")
        .select("id, amount, date, receipt_no, students(name, classes(name)), companies(display_name,logo_url)")
        .eq("student_id", studentId)
        .order("date", { ascending: true });

      if (error || !fees?.length) {
        tbody.innerHTML = `<tr><td colspan="3">No payments found.</td></tr>`;
        return;
      }

      fees.forEach(fee => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fee.date}</td>
          <td>$${fee.amount}</td>
          <td><button class="view-btn" onclick='openTemplateChooser(${JSON.stringify(JSON.stringify(fee))})'>View</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Open template chooser modal
    window.openTemplateChooser = function(feeJson) {
      selectedFee = JSON.parse(feeJson);
      document.getElementById("templateModal").style.display = "flex";
    };

    // Choose template and print
    window.chooseTemplate = function(templateId) {
      const fee = selectedFee;
      const printArea = document.getElementById("printArea");
      let html = "";

      if (templateId === 1) {
        html = `
          <div class="receipt template1">
            <header>
              <img src="${fee.companies?.logo_url || ""}" class="logo" />
              <h2>${fee.companies?.display_name || "Company"}</h2>
              <h3>Payment Receipt</h3>
            </header>
            <section>
              <p><strong>Student:</strong> ${fee.students?.name || "N/A"}</p>
              <p><strong>Class:</strong> ${fee.students?.classes?.name || "N/A"}</p>
              <p><strong>Amount:</strong> $${fee.amount}</p>
              <p><strong>Date:</strong> ${fee.date}</p>
              <p><strong>Receipt No:</strong> ${fee.receipt_no}</p>
            </section>
            <footer>Thank you for your payment!</footer>
          </div>`;
      }

      if (templateId === 2) {
        html = `
          <div class="receipt template2">
            <header>
              <h1>${fee.companies?.display_name || "Company"}</h1>
              <small>Payment Receipt</small>
            </header>
            <section>
              <table>
                <tr><td>Student</td><td>${fee.students?.name}</td></tr>
                <tr><td>Class</td><td>${fee.students?.classes?.name}</td></tr>
                <tr><td>Amount</td><td>$${fee.amount}</td></tr>
                <tr><td>Date</td><td>${fee.date}</td></tr>
                <tr><td>Receipt #</td><td>${fee.receipt_no}</td></tr>
              </table>
            </section>
            <footer>Powered by ${fee.companies?.display_name || "Company"}</footer>
          </div>`;
      }

      if (templateId === 3) {
        html = `
          <div class="receipt template3">
            <header>
              <h2>Receipt</h2>
              <p>${fee.companies?.display_name || "Company"}</p>
            </header>
            <section>
              <div><strong>Student:</strong> ${fee.students?.name}</div>
              <div><strong>Class:</strong> ${fee.students?.classes?.name}</div>
              <div><strong>Amount:</strong> $${fee.amount}</div>
              <div><strong>Date:</strong> ${fee.date}</div>
              <div><strong>Receipt:</strong> ${fee.receipt_no}</div>
            </section>
            <footer>Digital Copy - ${new Date().getFullYear()}</footer>
          </div>`;
      }

      printArea.innerHTML = html;
      document.getElementById("templateModal").style.display = "none";
      setTimeout(() => window.print(), 200);
    };

    document.getElementById("classSelect").addEventListener("change", e => loadStudents(e.target.value));
    document.getElementById("studentSearch").addEventListener("input", e => {
      const classId = document.getElementById("classSelect").value;
      loadStudents(classId, e.target.value);
    });
    document.getElementById("studentSelect").addEventListener("change", e => loadPayments(e.target.value));

    loadClasses();
  </script>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f4f7fb; margin:0; padding:20px; }
    .container { max-width:800px; margin:auto; }
    h1 { text-align:center; color:#007bff; }

    .filter-panel { background:#fff; border-radius:12px; box-shadow:0 3px 8px rgba(0,0,0,0.1); margin:20px 0; }
    .filter-body { padding:15px; }
    .filter-body select, .filter-body input { width:100%; padding:10px; margin-bottom:12px; }

    .history { background:#fff; border-radius:12px; padding:20px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:10px; border-bottom:1px solid #eee; }
    .view-btn { padding:6px 12px; background:#007bff; color:#fff; border:none; border-radius:6px; cursor:pointer; }

    /* Modal */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999; }
    .modal-content { background:#fff; padding:20px; border-radius:10px; max-width:900px; width:95%; }
    .template-grid { display:grid; grid-template-columns:1fr; gap:15px; }
    @media(min-width:768px){ .template-grid { grid-template-columns:repeat(3,1fr); } }
    .template-preview { border:1px solid #ddd; padding:10px; border-radius:8px; background:#fafafa; text-align:center; }
    .template-preview button { margin-top:10px; padding:6px 12px; background:#28a745; color:#fff; border:none; border-radius:5px; }

    /* Printable area */
    #printArea { display:none; }
    @media print {
      body * { visibility:hidden; }
      #printArea, #printArea * { visibility:visible; }
      #printArea { display:block !important; position:absolute; top:0; left:0; width:100%; }
      @page { size: A5 landscape; margin:10mm; }
    }

    /* Receipt Styles */
    .receipt { width:100%; height:100%; }
    .template1 { font-family:Arial; border:2px solid #007bff; padding:20px; }
    .template1 header { text-align:center; }
    .template1 .logo { height:50px; }
    .template1 footer { margin-top:20px; text-align:center; }

    .template2 { font-family:Georgia; border:1px dashed #333; padding:20px; }
    .template2 header { text-align:center; color:#007bff; }
    .template2 table { width:100%; }
    .template2 td { padding:5px; border-bottom:1px solid #ccc; }

    .template3 { font-family:'Courier New'; padding:20px; background:#fef9e7; border:1px solid #999; }
    .template3 header { text-align:center; margin-bottom:10px; }
    .template3 section div { margin:6px 0; }
    .template3 footer { text-align:right; margin-top:20px; font-size:0.8rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Student Payment Receipts</h1>

    <!-- Filters -->
    <div class="filter-panel">
      <div class="filter-body">
        <select id="classSelect"><option value="">-- Select Class --</option></select>
        <select id="studentSelect"><option value="">-- Select Student --</option></select>
        <input type="text" id="studentSearch" placeholder="Search Student..." />
      </div>
    </div>

    <!-- Payment history -->
    <div class="history">
      <h3>Payment History</h3>
      <table id="paymentTable">
        <thead><tr><th>Date</th><th>Amount</th><th>Action</th></tr></thead>
        <tbody><tr><td colspan="3">Select a student to view payments.</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Template chooser modal -->
  <div id="templateModal" class="modal">
    <div class="modal-content">
      <h3>Choose Receipt Template</h3>
      <div class="template-grid">
        <div class="template-preview">
          <p>Template 1 - Classic</p>
          <button onclick="chooseTemplate(1)">Choose</button>
        </div>
        <div class="template-preview">
          <p>Template 2 - Table Format</p>
          <button onclick="chooseTemplate(2)">Choose</button>
        </div>
        <div class="template-preview">
          <p>Template 3 - Minimalist</p>
          <button onclick="chooseTemplate(3)">Choose</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Printable area -->
  <div id="printArea"></div>
</body>
</html>
