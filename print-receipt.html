<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Receipts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Supabase -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/+esm";

    const SUPABASE_URL = "https://ndishfwnkzdedfcywcle.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM"; // üîë replace with your real anon key
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentCompanyId = null;

    // Load user + company
    async function loadDynamicHeader() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'index.html';
        return;
      }

      const { data, error } = await supabase
        .from('users')
        .select('company_id')
        .eq('id', session.user.id)
        .single();

      if (error || !data) return;
      currentCompanyId = data.company_id;
    }

    // Load students
    async function loadStudents(classId = "", search = "") {
      if (!currentCompanyId) return;
      let query = supabase
        .from("students")
        .select("id, name, created_at")
        .eq("company_id", currentCompanyId);

      if (classId) query = query.eq("class_id", classId);
      if (search) query = query.ilike("name", `%${search}%`);

      const { data: students } = await query.order("name");

      const studentSelect = document.getElementById("studentSelect");
      studentSelect.innerHTML = `<option value="">-- Select Student --</option>`;
      students?.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name;
        studentSelect.appendChild(opt);
      });
    }

    // Load classes
    async function loadClasses() {
      if (!currentCompanyId) return;
      const { data: classes } = await supabase
        .from("classes")
        .select("id, name")
        .eq("company_id", currentCompanyId)
        .order("name");

      const classSelect = document.getElementById("classSelect");
      classSelect.innerHTML = `<option value="">-- Select Class --</option>`;
      classes?.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        classSelect.appendChild(opt);
      });
    }

    // Load payments + print
    async function loadPayments(studentId) {
      const tbody = document.querySelector("#paymentTable tbody");
      tbody.innerHTML = "";

      if (!studentId) {
        tbody.innerHTML = `<tr><td colspan="4">Select a student to view payments.</td></tr>`;
        return;
      }

      const { data: student } = await supabase
        .from("students")
        .select("id, name, phone, totalFee, initialPayment, balanceFee, created_at, classes(name), companies(display_name, logo_url)")
        .eq("id", studentId)
        .single();

      const { data: fees } = await supabase
        .from("fees")
        .select("id, amount, date, receipt_no")
        .eq("student_id", studentId)
        .eq("company_id", currentCompanyId)
        .order("date", { ascending: true });

      const totalPaid = fees?.reduce((sum, f) => sum + f.amount, 0) ?? 0;
      const pending = Math.max((student?.totalFee ?? 0) - totalPaid, 0);

      // Print Receipt
      window.openTemplateChooser = function(feeJson) {
        const fee = JSON.parse(feeJson);
        const data = {
          companyLogo: student?.companies?.logo_url || "",
          companyName: student?.companies?.display_name || "Company",
          receiptNo: fee.receipt_no || "####",
          date: new Date(fee.date).toLocaleDateString(),
          studentName: student?.name,
          className: student?.classes?.name,
          dateOfJoining: student?.created_at ? new Date(student.created_at).toLocaleDateString() : "...............",
          totalFee: student?.totalFee || 0,
          paidFee: totalPaid,
          balanceFee: pending,
          amount: fee.amount
        };

        const html = `
          <div class="receipt">
            <div class="receipt-header">
              ${data.companyLogo ? `<img src="${data.companyLogo}" class="logo"/>` : ""}
              <div>
                <h2>${data.companyName}</h2>
                <h3>Payment Receipt</h3>
              </div>
            </div>
            <div class="info">
              <div>
                <p><strong>Student:</strong> ${data.studentName}</p>
                <p><strong>Class:</strong> ${data.className}</p>
                <p><strong>Date of Joining:</strong> ${data.dateOfJoining}</p>
              </div>
              <div style="text-align:right;">
                <p><strong>Receipt No:</strong> ${data.receiptNo}</p>
                <p><strong>Date:</strong> ${data.date}</p>
              </div>
            </div>
            <table class="fee-table">
              <thead>
                <tr><th>Sr No.</th><th>Particulars</th><th>Amount</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td>1</td>
                  <td>
                    Student Fee
                    <div class="meta">
                      Total Fee: Rp ${data.totalFee}<br>
                      Paid Fee: Rp ${data.paidFee}<br>
                      Balance Fee: Rp ${data.balanceFee}
                    </div>
                  </td>
                  <td>Rp ${data.amount}</td>
                </tr>
              </tbody>
            </table>
            <div class="footer">
              <p><strong>Total: Rp ${data.amount}</strong></p>
              <p class="note">Fees once paid are non-refundable</p>
              <p class="thanks">Thank you for your payment</p>
            </div>
          </div>
        `;
        document.getElementById("printArea").innerHTML = html;
        setTimeout(() => window.print(), 200);
      };

      fees?.forEach(fee => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(fee.date).toLocaleDateString()}</td>
          <td>${fee.receipt_no}</td>
          <td>Rp ${fee.amount.toLocaleString()}</td>
          <td><button class="view-btn" onclick='openTemplateChooser(${JSON.stringify(JSON.stringify(fee))})'>üñ®Ô∏è Print</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Init
    document.addEventListener("DOMContentLoaded", async () => {
      await loadDynamicHeader();
      await loadClasses();
      loadStudents();

      document.getElementById("classSelect").addEventListener("change", e => {
        loadStudents(e.target.value);
        loadPayments(null);
      });
      document.getElementById("studentSelect").addEventListener("change", e => loadPayments(e.target.value));
      document.getElementById("studentSearch").addEventListener("input", e => {
        loadStudents(document.getElementById("classSelect").value, e.target.value);
        loadPayments(null);
      });
      document.getElementById("backBtn").addEventListener("click", () => history.back());
    });
  </script>

  <!-- Styles -->
  <style>
    :root {
      --primary: #2563eb;
      --secondary: #10b981;
      --bg: #f4f7fa;
      --card: #ffffff;
      --shadow: 0 6px 16px rgba(0,0,0,0.08);
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 20px;
      color: #1f2937;
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 20px;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 25px;
      transition: transform .2s;
    }
    .card:hover { transform: translateY(-4px); }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }
    .filter-row select, .filter-row input {
      flex: 1;
      min-width: 160px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 14px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      font-size: 0.9rem;
    }
    tr:hover { background: #f3f4f6; }
    .view-btn {
      background: var(--primary);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background .2s;
    }
    .view-btn:hover { background: #1d4ed8; }
    .back-button-container {
  margin-top: 20px;
  text-align: center;
}

.back-button {
  display: inline-block;
  width: 90vw;              /* make it wide like in Students page */
  max-width: 400px;         /* don‚Äôt let it stretch too much on big screens */
  padding: 14px 20px;       /* taller + wider */
  font-size: 1.1rem;        /* bigger text */
  background-color: #6366F1;
  color: #fff;
  font-weight: 600;
  border-radius: 10px;
  text-align: center;
  text-decoration: none;
  box-shadow: var(--shadow);
  transition: background-color 0.2s ease;
}
.back-button:hover {
  background-color: #4f46e5;
}


    #printArea { display: none; }
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { display: block; position: fixed; top:0; left:0; width:100%; }
    }
  </style>
</head>
<body>
  <h1>Receipts</h1>
  <div class="card">
    <h3>Payment History</h3>
    <div class="filter-row">
      <select id="classSelect"><option value="">-- Select Class --</option></select>
      <select id="studentSelect"><option value="">-- Select Student --</option></select>
      <input type="text" id="studentSearch" placeholder="üîç Search by name...">
    </div>
    <table id="paymentTable">
      <thead>
        <tr><th>Date</th><th>Receipt No.</th><th>Amount</th><th>Action</th></tr>
      </thead>
      <tbody>
        <tr><td colspan="4">Select a student to view payments.</td></tr>
      </tbody>
    </table>
  </div>
  <div class="back-button-container">
  <a href="javascript:history.back()" class="back-button">
    <i class="fa fa-arrow-left"></i> Back
  </a>
</div>

  <div id="printArea"></div>
</body>
</html>
