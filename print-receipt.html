<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Receipts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Supabase -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/+esm";

    const SUPABASE_URL = "https://ndishfwnkzdedfcywcle.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let selectedFee = null;
    let currentCompanyId = null;

    // Load header (company info)
    async function loadDynamicHeader() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'index.html';
        return;
      }
      const user = session.user;
      const { data, error } = await supabase
        .from('users')
        .select('company_id, companies(display_name, logo_url)')
        .eq('id', user.id)
        .single();

      if (error || !data || !data.companies) {
        console.error("Error fetching company data:", error?.message);
        return;
      }

      currentCompanyId = data.company_id;
      document.getElementById('headerTitle').textContent = data.companies.display_name || 'Receipts';
      if (data.companies.logo_url) {
        document.getElementById('headerLogo').src = data.companies.logo_url;
        document.getElementById('headerLogo').style.display = 'inline-block';
      }
    }

    // Load classes
    async function loadClasses() {
      if (!currentCompanyId) return;
      const { data: classes } = await supabase
        .from("classes")
        .select("id,name")
        .eq("company_id", currentCompanyId)
        .order("name");

      const classSelect = document.getElementById("classSelect");
      classSelect.innerHTML = `<option value="">-- All Classes --</option>`;
      classes?.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        classSelect.appendChild(opt);
      });
    }

    // Load students
    async function loadStudents(classId, search = "") {
      const studentSelect = document.getElementById("studentSelect");
      studentSelect.innerHTML = `<option value="">-- Select Student --</option>`;

      let query = supabase
        .from("students")
        .select("id, name, class_id")
        .eq("company_id", currentCompanyId)
        .order("name");

      if (classId) query = query.eq("class_id", classId);
      if (search) query = query.ilike("name", `%${search}%`);

      const { data: students, error } = await query;

      if (error) {
        console.error("Error loading students:", error.message);
        return;
      }

      if (!students || students.length === 0) {
        studentSelect.innerHTML = `<option value="">-- No students found --</option>`;
        return;
      }

      students.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name;
        studentSelect.appendChild(opt);
      });
    }

    // Load payments
    async function loadPayments(studentId) {
      const tbody = document.querySelector("#paymentTable tbody");
      tbody.innerHTML = "";

      if (!studentId) {
        tbody.innerHTML = `<tr><td colspan="3">Select a student to view payments.</td></tr>`;
        return;
      }

      const { data: fees, error } = await supabase
        .from("fees")
        .select("id, amount, date, receipt_no, students(name, classes(name)), companies(display_name, logo_url)")
        .eq("student_id", studentId)
        .eq("company_id", currentCompanyId)
        .order("date", { ascending: true });

      if (error || !fees?.length) {
        tbody.innerHTML = `<tr><td colspan="3">No payments found.</td></tr>`;
        return;
      }

      fees.forEach(fee => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fee.date}</td>
          <td>$${fee.amount}</td>
          <td><button class="view-btn" onclick='openTemplateChooser(${JSON.stringify(JSON.stringify(fee))})'>View</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Open modal
    window.openTemplateChooser = function(feeJson) {
      selectedFee = JSON.parse(feeJson);
      document.getElementById("templateModal").style.display = "flex";
    };

    // Close modal
    window.closeTemplateChooser = function() {
      document.getElementById("templateModal").style.display = "none";
      selectedFee = null;
    };

    // Choose template & print
    window.chooseTemplate = function(templateId) {
      const fee = selectedFee;
      if (!fee) return;
      const printArea = document.getElementById("printArea");
      let html = "";

      const companyName = fee.companies?.display_name || "Company";
      const studentName = fee.students?.name || "N/A";
      const className = fee.students?.classes?.name || "N/A";

      if (templateId === 1) {
        html = `
          <div class="receipt template1">
            <header>
              <img src="${fee.companies?.logo_url || ""}" class="logo" />
              <h2>${companyName}</h2>
              <h3>Payment Receipt</h3>
            </header>
            <section>
              <p><strong>Student:</strong> ${studentName}</p>
              <p><strong>Class:</strong> ${className}</p>
              <p><strong>Amount:</strong> $${fee.amount}</p>
              <p><strong>Date:</strong> ${fee.date}</p>
              <p><strong>Receipt No:</strong> ${fee.receipt_no}</p>
            </section>
            <footer>Thank you for your payment!</footer>
          </div>`;
      }

      if (templateId === 2) {
        html = `
          <div class="receipt template2">
            <header>
              <h1>${companyName}</h1>
              <small>Payment Receipt</small>
            </header>
            <section>
              <table>
                <tr><td>Student</td><td>${studentName}</td></tr>
                <tr><td>Class</td><td>${className}</td></tr>
                <tr><td>Amount</td><td>$${fee.amount}</td></tr>
                <tr><td>Date</td><td>${fee.date}</td></tr>
                <tr><td>Receipt #</td><td>${fee.receipt_no}</td></tr>
              </table>
            </section>
            <footer>Powered by ${companyName}</footer>
          </div>`;
      }

      if (templateId === 3) {
        html = `
          <div class="receipt template3">
            <header>
              <h2>Receipt</h2>
              <p>${companyName}</p>
            </header>
            <section>
              <div><strong>Student:</strong> ${studentName}</div>
              <div><strong>Class:</strong> ${className}</div>
              <div><strong>Amount:</strong> $${fee.amount}</div>
              <div><strong>Date:</strong> ${fee.date}</div>
              <div><strong>Receipt:</strong> ${fee.receipt_no}</div>
            </section>
            <footer>Digital Copy - ${new Date().getFullYear()}</footer>
          </div>`;
      }

      printArea.innerHTML = html;
      document.getElementById("templateModal").style.display = "none";
      setTimeout(() => window.print(), 200);
    };

    // Event bindings
    document.addEventListener("DOMContentLoaded", async () => {
      await loadDynamicHeader();
      await loadClasses();

      document.getElementById("classSelect").addEventListener("change", e => loadStudents(e.target.value));
      document.getElementById("studentSearch").addEventListener("input", e => {
        const classId = document.getElementById("classSelect").value;
        loadStudents(classId, e.target.value);
      });
      document.getElementById("studentSelect").addEventListener("change", e => loadPayments(e.target.value));
    });
  </script>

  <!-- Styles -->
  <style>
    :root {
      --primary-color: #007bff;
      --background-color: #f0f4f8;
      --card-background: #ffffff;
      --text-color: #333;
      --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.05);
      --input-background: #f7f7f7;
      --input-border: #ddd;
    }
    body { font-family: 'Segoe UI', sans-serif; background:var(--background-color); margin:0; padding:20px; }
    .container { max-width:600px; margin:auto; }

    .company-header-box {
      display:flex; align-items:center; justify-content:center; gap:15px;
      background:var(--card-background); border-radius:12px;
      padding:20px; box-shadow:var(--shadow-light); margin-bottom:25px; width:100%;
    }
    #headerLogo { height:50px; width:50px; border-radius:50%; object-fit:cover; display:none; }
    #headerTitle { font-size:1.5rem; font-weight:600; color:var(--primary-color); }

    .filter-panel { background:var(--card-background); border-radius:12px; box-shadow:var(--shadow-light); margin:20px 0; }
    .filter-body { padding:15px; }
    .filter-body select, .filter-body input {
      width:100%; padding:10px; margin-bottom:12px;
      border:1px solid var(--input-border); border-radius:8px;
      background:var(--input-background);
    }

    .history { background:var(--card-background); border-radius:12px; padding:20px; box-shadow:var(--shadow-light); }
    h3 { color:var(--primary-color); text-align:center; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:10px; border-bottom:1px solid var(--input-border); text-align:left; }
    .view-btn { padding:6px 12px; background:var(--primary-color); color:#fff; border:none; border-radius:6px; cursor:pointer; }
    .view-btn:hover { background:#0056b3; }

    /* Modal */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999; }
    .modal-content { background:var(--card-background); padding:20px; border-radius:10px; max-width:900px; width:95%; }
    .template-grid { display:grid; grid-template-columns:1fr; gap:15px; }
    @media(min-width:768px){ .template-grid { grid-template-columns:repeat(3,1fr); } }
    .template-preview { border:1px solid #ddd; padding:10px; border-radius:8px; background:var(--input-background); text-align:center; }
    .template-preview button { margin-top:10px; padding:6px 12px; background:#28a745; color:#fff; border:none; border-radius:5px; }
    .close-modal-btn { padding:6px 12px; background:#ef5350; color:#fff; border:none; border-radius:5px; cursor:pointer; margin-top:10px; }

  /* Print */
#printArea { display:none; }

@media print {
  /* Reset everything */
  * {
    margin: 0 !important;
    padding: 0 !important;
    box-shadow: none !important;
    background: transparent !important;
  }

  body * { 
    visibility: hidden; 
  }

  #printArea, #printArea * { 
    visibility: visible; 
  }

  #printArea {
    display: block !important;
    position: fixed; /* lock to the page */
    top: 0;
    left: 0;
    width: 210mm;     /* exact A5 landscape width */
    height: 148mm;    /* exact A5 landscape height */
    margin: 0 auto;
    overflow: hidden; /* prevent spill */
  }

  @page {
    size: A5 landscape;
    margin: 10mm;
  }

  .receipt {
    width: 100%;
    height: 100%;
    padding: 10mm;
    page-break-after: avoid;
    page-break-before: avoid;
    page-break-inside: avoid;
  }
}



    /* Receipt styles */
    .receipt { width:90%; height:90%; }
    .template1 { font-family:Arial; border:2px solid var(--primary-color); padding:20px; }
    .template1 header { text-align:center; }
    .template1 .logo { height:50px; }
    .template1 footer { margin-top:20px; text-align:center; }

    .template2 { font-family:Georgia; border:1px dashed #333; padding:20px; }
    .template2 header { text-align:center; color:var(--primary-color); }
    .template2 table { width:100%; }
    .template2 td { padding:5px; border-bottom:1px solid #ccc; }

    .template3 { font-family:'Courier New'; padding:20px; background:#fef9e7; border:1px solid #999; }
    .template3 header { text-align:center; margin-bottom:10px; }
    .template3 section div { margin:6px 0; }
    .template3 footer { text-align:right; margin-top:20px; font-size:0.8rem; }
  </style>
</head>
<body>
<div class="container">
  <!-- Company Header -->
  <header class="company-header-box">
    <img id="headerLogo" src="" alt="Company Logo">
    <h1 id="headerTitle">Receipts</h1>
  </header>

  <!-- Filters -->
  <div class="filter-panel">
    <div class="filter-body">
      <select id="classSelect"><option value="">-- All Classes --</option></select>
      <select id="studentSelect"><option value="">-- Select Student --</option></select>
      <input type="text" id="studentSearch" placeholder="Search Student..." />
    </div>
  </div>

  <!-- Payment History -->
  <div class="history">
    <h3>Payment History</h3>
    <table id="paymentTable">
      <thead><tr><th>Date</th><th>Amount</th><th>Action</th></tr></thead>
      <tbody><tr><td colspan="3">Select a student to view payments.</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Modal for Templates -->
<div id="templateModal" class="modal">
  <div class="modal-content">
    <h3>Choose Receipt Template</h3>
    <div class="template-grid">
      <div class="template-preview">
        <p>Template 1 - Classic</p>
        <button onclick="chooseTemplate(1)">Choose</button>
      </div>
      <div class="template-preview">
        <p>Template 2 - Table Format</p>
        <button onclick="chooseTemplate(2)">Choose</button>
      </div>
      <div class="template-preview">
        <p>Template 3 - Minimalist</p>
        <button onclick="chooseTemplate(3)">Choose</button>
      </div>
    </div>
    <button class="close-modal-btn" onclick="closeTemplateChooser()">Close</button>
  </div>
</div>

<!-- Hidden Print Area -->
<div id="printArea"></div>
</body>
</html>
