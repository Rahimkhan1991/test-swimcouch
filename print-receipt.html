<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Print Receipt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/+esm";

    const SUPABASE_URL = "https://ndishfwnkzdedfcywcle.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kaXNoZndua3pkZWRmY3l3Y2xlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTk0MjcsImV4cCI6MjA3MTY3NTQyN30.CXQSfhR0MVLF40v2Tp-BcENBpHpPshG9Ys3zLYiBQaM";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentCompanyId = null;

    // Load user + company
    async function loadDynamicHeader() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'index.html';
        return;
      }

      const { data, error } = await supabase
        .from('users')
        .select('company_id, companies(display_name, logo_url)')
        .eq('id', session.user.id)
        .single();

      if (error || !data) return;

      currentCompanyId = data.company_id;
      document.getElementById('headerTitle').textContent = data.companies.display_name;
      if (data.companies.logo_url) {
        document.getElementById('headerLogo').src = data.companies.logo_url;
        document.getElementById('headerLogo').style.display = "inline-block";
      }

      // We call loadClasses here now, which will in turn call loadStudents
      // loadStudents(); // This line is no longer needed here
    }

    // Load students based on an optional classId and search term
    async function loadStudents(classId = "", search = "") {
      if (!currentCompanyId) return;
      
      let query = supabase
        .from("students")
        .select("id, name")
        .eq("company_id", currentCompanyId)
        .ilike("name", `%${search}%`);

      if (classId) {
        query = query.eq("class_id", classId);
      }

      const { data: students } = await query.order("name");

      const studentSelect = document.getElementById("studentSelect");
      studentSelect.innerHTML = `<option value="">-- Select Student --</option>`;
      students?.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name;
        studentSelect.appendChild(opt);
      });
    }

    // Load classes
    async function loadClasses() {
      if (!currentCompanyId) return;
      const { data: classes } = await supabase
        .from("classes")
        .select("id, name")
        .eq("company_id", currentCompanyId)
        .order("name");

      const classSelect = document.getElementById("classSelect");
      classSelect.innerHTML = `<option value="">-- Select Class --</option>`;
      classes?.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        classSelect.appendChild(opt);
      });
    }

    // Load payments
    async function loadPayments(studentId) {
      const tbody = document.querySelector("#paymentTable tbody");
      tbody.innerHTML = "";

      if (!studentId) {
        tbody.innerHTML = `<tr><td colspan="3">Select a student to view payments.</td></tr>`;
        return;
      }

      // 1. Get student details (totalFee etc.)
      const { data: student, error: studentError } = await supabase
        .from("students")
        .select("id, name, phone, totalFee, initialPayment, balanceFee, created_at, classes(name), companies(display_name, logo_url)")
        .eq("id", studentId)
        .single();

      if (studentError) {
        console.error("Error loading student:", studentError.message);
        return;
      }

      // 2. Get all payments for this student
      const { data: fees, error: feesError } = await supabase
        .from("fees")
        .select("id, amount, date, receipt_no")
        .eq("student_id", studentId)
        .eq("company_id", currentCompanyId)
        .order("date", { ascending: true });

      if (feesError) {
        console.error("Error loading fees:", feesError.message);
        return;
      }

      // 3. Calculate totals
      const totalPaid = fees?.reduce((sum, f) => sum + f.amount, 0) ?? 0;
      const pending = Math.max((student?.totalFee ?? 0) - totalPaid, 0);

      // Open receipt template
      window.openTemplateChooser = function(feeJson) {
        const fee = JSON.parse(feeJson);

        const data = {
          companyLogo: student?.companies?.logo_url || "",
          companyName: student?.companies?.display_name || "Company",
          receiptNo: fee.receipt_no || "####",
          date: fee.date,
          studentName: student?.name,
          className: student?.classes?.name,
          dateOfJoining: student?.created_at || "...............",
          totalFee: student?.totalFee || 0,
          paidFee: totalPaid,
          balanceFee: pending,
          amount: fee.amount
        };
        // Add this line after the 'data' object is defined
// Reformat the dateOfJoining string
if (data.dateOfJoining && data.dateOfJoining !== "...............") {
    const dateObj = new Date(data.dateOfJoining);
    data.dateOfJoining = dateObj.toLocaleDateString();
}

        const html = `
          <div class="receipt">
            <div class="receipt-header">
              ${data.companyLogo ? `<img src="${data.companyLogo}" class="logo"/>` : ""}
              <div>
                <h2>${data.companyName}</h2>
                <h3>Payment Receipt</h3>
              </div>
            </div>

            <div class="info">
              <p><strong>Receipt No:</strong> ${data.receiptNo}</p>
              <p><strong>Date:</strong> ${data.date}</p>
              <p><strong>Student:</strong> ${data.studentName}</p>
              <p><strong>Class:</strong> ${data.className}</p>
              <p><strong>Date of Joining:</strong> ${data.dateOfJoining}</p>
            </div>

            <table class="fee-table">
              <thead>
                <tr>
                  <th>Sr No.</th>
                  <th>Particulars</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>1</td>
                  <td>
                    Student Fee
                    <div class="meta">
                      Total Fee: ${data.totalFee}<br>
                      Paid Fee: ${data.paidFee}<br>
                      Balance Fee: ${data.balanceFee}
                    </div>
                  </td>
                  <td>Rp ${data.amount}</td>
                </tr>
              </tbody>
            </table>

            <div class="footer">
              <p><strong>Total: Rp ${data.amount}</strong></p>
              <p>Fees Paid Once is not Refundable</p>
              <p class="note">This is a computer generated invoice, no signature required.</p>
              <p class="thanks">Thank you for your payment</p>
            </div>
          </div>
        `;

        document.getElementById("printArea").innerHTML = html;
        setTimeout(() => window.print(), 200);
      };

      fees.forEach(fee => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fee.date}</td>
          <td>Rp ${fee.amount}</td>
          <td><button class="view-btn" onclick='openTemplateChooser(${JSON.stringify(JSON.stringify(fee))})'>Print</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Bind events
    document.addEventListener("DOMContentLoaded", async () => {
      await loadDynamicHeader();
      await loadClasses(); // <-- Call the function to load classes initially

      const classSelect = document.getElementById("classSelect");
      const studentSelect = document.getElementById("studentSelect");

      // Event listener for the class dropdown
      classSelect.addEventListener("change", e => {
        const selectedClassId = e.target.value;
        loadStudents(selectedClassId); // Filter students by selected class
        loadPayments(null); // Clear the payments table when class changes
      });

      // Event listener for the student dropdown
      studentSelect.addEventListener("change", e => loadPayments(e.target.value));
    });
  </script>

  <style>
    body { font-family: Arial, sans-serif; background:#f0f4f8; margin:0; padding:20px; }
    .container { max-width:700px; margin:auto; }
    .company-header-box { display:flex; align-items:center; gap:15px; margin-bottom:20px; }
    #headerLogo { height:50px; width:50px; border-radius:50%; display:none; object-fit:cover; }
    #headerTitle { font-size:1.5rem; color:#007bff; }
    .history { background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
    .view-btn { padding:6px 12px; background:#007bff; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    /* Print Area */
    #printArea { display:none; }
    @media print {
      body * { visibility:hidden; }
      #printArea, #printArea * { visibility:visible; }
      #printArea {
        display:block !important;
        position:fixed; top:0; left:0;
        width:210mm; height:148mm; /* A5 landscape */
        margin:0; padding:0;
      }
      @page { size: A5 landscape; margin:10mm; }
      .receipt { width:100%; height:100%; padding:10mm; box-sizing:border-box; }
    }
    /* Receipt Styles */
    .receipt-header { display:flex; align-items:center; gap:15px; margin-bottom:15px; }
    .receipt-header .logo { width:60px; height:60px; object-fit:contain; }
    .receipt-header h2 { margin:0; font-size:1.2rem; }
    .receipt-header h3 { margin:0; font-size:1rem; color:#555; }
    .info p { margin:3px 0; font-size:0.9rem; }
    .fee-table { width:100%; border-collapse:collapse; margin-top:15px; }
    .fee-table th, .fee-table td { border:1px solid #ccc; padding:8px; font-size:0.9rem; }
    .fee-table .meta { font-size:0.8rem; color:#555; margin-top:5px; }
    .footer { margin-top:20px; font-size:0.9rem; }
    .footer .note { font-size:0.8rem; color:#666; }
    .footer .thanks { margin-top:10px; text-align:center; font-weight:bold; }
  </style>
</head>
<body>
<div class="container">
  <header class="company-header-box">
    <img id="headerLogo" src="" alt="Company Logo">
    <h1 id="headerTitle">Receipts</h1>
  </header>

  <div class="history">
    <h3>Payment History</h3>
    <select id="classSelect"><option value="">-- Select Class --</option></select>
    <select id="studentSelect"><option value="">-- Select Student --</option></select>
    <table id="paymentTable">
      <thead><tr><th>Date</th><th>Amount</th><th>Action</th></tr></thead>
      <tbody><tr><td colspan="3">Select a student to view payments.</td></tr></tbody>
    </table>
  </div>
</div>

<div id="printArea"></div>
</body>
</html>